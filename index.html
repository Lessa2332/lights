<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR –≥—ñ—Ä–ª—è–Ω–¥–∞ –∑ –≥–æ–ª–æ—Å–æ–≤–∏–º –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º">
    <title>üéÑ AR –ì—ñ—Ä–ª—è–Ω–¥–∞</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Arial', sans-serif;
            touch-action: none;
        }
        
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c2461, #1e3799);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffd700;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .loader h1 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .loader p {
            font-size: 1.1em;
            margin: 8px 0;
            opacity: 0.9;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
            font-size: 4em;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }

        /* –ì–æ–ª–æ–≤–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
        .main-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 95%;
        }

        .main-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(145deg, #4a69bd, #3c538f);
            color: white;
            font-size: 0.95em;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            min-width: 150px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .main-btn:hover {
            background: linear-gradient(145deg, #5a79cd, #4c638f);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .main-btn:active {
            transform: translateY(0);
        }

        .main-btn.active {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            color: white;
            border-color: #81C784;
        }

        .main-btn.off {
            background: linear-gradient(145deg, #f44336, #d32f2f);
            border-color: #ef5350;
        }

        /* –ü–∞–Ω–µ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
        .settings-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: none;
            max-width: 300px;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
            font-size: 1.1em;
        }

        .setting-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
        }

        .setting-option input[type="radio"] {
            margin-right: 10px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .slider-container label {
            margin-right: 10px;
            min-width: 100px;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .value-display {
            margin-left: 10px;
            min-width: 30px;
            text-align: center;
            color: #ffd700;
        }

        /* –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å */
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 20px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: none;
        }

        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
            font-size: 1.1em;
        }

        .info-panel p {
            margin: 5px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .voice-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ff4444;
            animation: voicePulse 1s infinite;
        }

        @keyframes voicePulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .voice-indicator.active {
            background: #4CAF50;
            animation: voiceActive 0.5s infinite alternate;
        }

        @keyframes voiceActive {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.3); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .main-controls {
                bottom: 15px;
                gap: 10px;
            }
            
            .main-btn {
                padding: 12px 20px;
                font-size: 0.9em;
                min-width: 130px;
            }
            
            .settings-panel,
            .info-panel {
                top: 15px;
                left: 15px;
                right: 15px;
                max-width: none;
                width: calc(100% - 30px);
            }
            
            .loader h1 {
                font-size: 1.5em;
            }
            
            .pulse {
                font-size: 3em;
            }
        }

        @media (max-width: 480px) {
            .main-controls {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                bottom: 10px;
            }
            
            .main-btn {
                width: 90%;
                max-width: 280px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class="loader" id="loader">
        <div class="pulse">‚ú®</div>
        <h1>AR –ì—ñ—Ä–ª—è–Ω–¥–∞</h1>
        <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
        <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">–ó–∞—á–µ–∫–∞–π—Ç–µ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</p>
    </div>
    
    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="info-panel">
        <h3>üé§ –ì–æ–ª–æ—Å–æ–≤–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h3>
        <p><span class="voice-indicator" id="voice-indicator"></span> <span id="voice-status">–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –≤–∏–º–∫–Ω–µ–Ω–æ</span></p>
        <p>üó£Ô∏è –°–∫–∞–∂—ñ—Ç—å –≥–æ–ª–æ—Å–Ω–æ:</p>
        <p>"–Ø–ª–∏–Ω–æ—á–∫–∞ –≥–æ—Ä–∏" - —É–≤—ñ–º–∫–Ω—É—Ç–∏</p>
        <p>"–ì—ñ—Ä–ª—è–Ω–¥–∞ —Å–≤—ñ—Ç–∏" - –∑–º—ñ–Ω–∏—Ç–∏ —Ä–µ–∂–∏–º</p>
        <p style="margin-top: 10px; color: #ffd700;">üí° –î–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞</p>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-group">
            <h3>üìê –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞</h3>
            <label class="setting-option">
                <input type="radio" name="marker-type" value="table" checked>
                <span>–ù–∞ —Å—Ç–æ–ª—ñ (–ª–µ–∂–∏—Ç—å)</span>
            </label>
            <label class="setting-option">
                <input type="radio" name="marker-type" value="wall">
                <span>–ù–∞ —Å—Ç—ñ–Ω—ñ (–≤–∏—Å–∏—Ç—å)</span>
            </label>
        </div>
        
        <div class="settings-group">
            <h3>üéõÔ∏è –ß—É—Ç–ª–∏–≤—ñ—Å—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞</h3>
            <div class="slider-container">
                <label>–ü–æ—Ä—ñ–≥:</label>
                <input type="range" id="sensitivity-slider" min="10" max="100" value="40">
                <span class="value-display" id="sensitivity-value">40</span>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤–æ–≥–Ω–∏–∫—ñ–≤</h3>
            <div class="slider-container">
                <label>–í–∏—Å–æ—Ç–∞:</label>
                <input type="range" id="height-slider" min="0" max="100" value="30">
                <span class="value-display" id="height-value">30</span>
            </div>
            <div class="slider-container">
                <label>–†–æ–∑–º—ñ—Ä:</label>
                <input type="range" id="size-slider" min="10" max="200" value="100">
                <span class="value-display" id="size-value">100%</span>
            </div>
        </div>
        
        <button id="apply-settings" class="main-btn" style="width: 100%; margin-top: 10px; padding: 10px;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
    </div>

    <!-- A-Frame —Å—Ü–µ–Ω–∞ -->
    <a-scene
        mindar-image="imageTargetSrc: marcher.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="bg-music" src="music.mp3" preload="auto" loop></audio>
        </a-assets>

        <a-camera
            id="camera"
            position="0 0 1.5"
            look-controls="enabled: true"
        ></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- 7 –∫—É–ª—å–æ–∫ –≥—ñ—Ä–ª—è–Ω–¥–∏ —É —Ñ–æ—Ä–º—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ (—Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–∑–æ—Ä—ñ) -->
            <a-entity id="garland-container" position="0 0.3 0" scale="1 1 1">
                <!-- –†—è–¥ 1 (–≤–µ—Ä—Ö–Ω—ñ–π) -->
                <a-sphere id="light1" class="garland-light" position="0 0.3 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 2 -->
                <a-sphere id="light2" class="garland-light" position="-0.15 0.15 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light3" class="garland-light" position="0.15 0.15 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 3 -->
                <a-sphere id="light4" class="garland-light" position="-0.25 0 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light5" class="garland-light" position="0.25 0 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 4 (–Ω–∏–∂–Ω—ñ–π) -->
                <a-sphere id="light6" class="garland-light" position="-0.1 -0.15 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light7" class="garland-light" position="0.1 -0.15 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –≥—ñ—Ä–ª—è–Ω–¥–∏ -->
                <a-light id="garland-light" type="point" color="#FFD700" intensity="0" distance="2" position="0 0 0" visible="true"></a-light>
            </a-entity>
        </a-entity>
    </a-scene>

    <!-- –ì–æ–ª–æ–≤–Ω—ñ –∫–Ω–æ–ø–∫–∏ -->
    <div class="main-controls">
        <button id="music-btn" class="main-btn">üéµ –ú—É–∑–∏–∫–∞</button>
        <button id="mic-btn" class="main-btn">üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
        <button id="lights-btn" class="main-btn" disabled>‚ú® –£–≤—ñ–º–∫–Ω—É—Ç–∏</button>
        <button id="settings-btn" class="main-btn">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
    </div>

    <script>
        // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
        const loader = document.getElementById('loader');
        const infoPanel = document.getElementById('info-panel');
        const voiceIndicator = document.getElementById('voice-indicator');
        const voiceStatus = document.getElementById('voice-status');
        const settingsPanel = document.getElementById('settings-panel');
        const targetEntity = document.querySelector('[mindar-image-target]');
        const garlandContainer = document.getElementById('garland-container');
        const musicBtn = document.getElementById('music-btn');
        const micBtn = document.getElementById('mic-btn');
        const lightsBtn = document.getElementById('lights-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const bgMusic = document.getElementById('bg-music');
        const garlandLight = document.getElementById('garland-light');
        const applySettingsBtn = document.getElementById('apply-settings');
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        const sensitivityValue = document.getElementById('sensitivity-value');
        const heightSlider = document.getElementById('height-slider');
        const heightValue = document.getElementById('height-value');
        const sizeSlider = document.getElementById('size-slider');
        const sizeValue = document.getElementById('size-value');
        const markerTypeRadios = document.querySelectorAll('input[name="marker-type"]');
        
        // –ú–∞—Å–∏–≤ –∑ 7 –∫—É–ª—å–∫–∞–º–∏
        const lights = Array.from(document.querySelectorAll('.garland-light'));
        
        // –ó–º—ñ–Ω–Ω—ñ —Å—Ç–∞–Ω—É
        let isMusicPlaying = false;
        let isMicActive = false;
        let isGarlandOn = false;
        let audioContext, analyser, dataArray, micStream;
        let animationInterval = null;
        let currentAnimation = null;
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        let settings = {
            markerType: 'table', // 'table' –∞–±–æ 'wall'
            sensitivity: 40,     // –ø–æ—Ä—ñ–≥ —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ (10-100)
            height: 0.3,         // –≤–∏—Å–æ—Ç–∞ –≤–æ–≥–Ω–∏–∫—ñ–≤ (0-1)
            size: 1.0           // —Ä–æ–∑–º—ñ—Ä –≤–æ–≥–Ω–∏–∫—ñ–≤ (0.1-2.0)
        };
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        console.log('AR –ì—ñ—Ä–ª—è–Ω–¥–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...');
        console.log('–ó–Ω–∞–π–¥–µ–Ω–æ –≤–æ–≥–Ω–∏–∫—ñ–≤:', lights.length);

        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å —Å–ª–∞–π–¥–µ—Ä—ñ–≤
        function updateSliderValues() {
            sensitivityValue.textContent = settings.sensitivity;
            heightValue.textContent = Math.round(settings.height * 100 / 0.01);
            sizeValue.textContent = Math.round(settings.size * 100) + '%';
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        function applySettings() {
            console.log('–ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:', settings);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –≤–æ–≥–Ω–∏–∫—ñ–≤ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–∏–ø—É –º–∞—Ä–∫–µ—Ä–∞
            if (settings.markerType === 'wall') {
                // –î–ª—è —Å—Ç—ñ–Ω–∏ - –≤–æ–≥–Ω–∏–∫–∏ –Ω–∏–∂—á–µ
                garlandContainer.setAttribute('position', `0 ${settings.height - 0.2} 0`);
            } else {
                // –î–ª—è —Å—Ç–æ–ª—É - –≤–æ–≥–Ω–∏–∫–∏ –≤–∏—â–µ
                garlandContainer.setAttribute('position', `0 ${settings.height} 0`);
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Ä–æ–∑–º—ñ—Ä –≤–æ–≥–Ω–∏–∫—ñ–≤
            garlandContainer.setAttribute('scale', `${settings.size} ${settings.size} ${settings.size}`);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å
            // (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ processAudio)
            
            updateSliderValues();
            settingsPanel.style.display = 'none';
            settingsBtn.textContent = '‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è';
            settingsBtn.classList.remove('active');
        }

        // –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
                loader.style.display = 'none';
                if (garlandContainer) {
                    garlandContainer.setAttribute('visible', 'true');
                }
                // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—É –ø–∞–Ω–µ–ª—å
                infoPanel.style.display = 'block';
                lightsBtn.disabled = false;
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                applySettings();
            });

            targetEntity.addEventListener('targetLost', () => {
                console.log("‚ÑπÔ∏è –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ.");
                if (garlandContainer) {
                    garlandContainer.setAttribute('visible', 'false');
                }
                // –í–∏–º–∏–∫–∞—î–º–æ –≤—Å–µ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
                stopGarland();
                if (bgMusic && !bgMusic.paused) bgMusic.pause();
                if (micStream) stopMicrophone();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                loader.style.display = 'flex';
                infoPanel.style.display = 'none';
                settingsPanel.style.display = 'none';
                resetUI();
                lightsBtn.disabled = true;
                
                // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω–∏
                isMusicPlaying = false;
                isMicActive = false;
                isGarlandOn = false;
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏ (—Ä–æ–±–∏—Ç—å –≤–æ–≥–Ω–∏–∫–∏ –≤–∏–¥–∏–º–∏–º–∏ —Ç–∞ –∞–Ω—ñ–º–æ–≤–∞–Ω–∏–º–∏)
        function igniteGarland() {
            if (isGarlandOn) return;
            
            console.log('‚ú® –ó–∞–ø–∞–ª—é—î–º–æ –≥—ñ—Ä–ª—è–Ω–¥—É!');
            isGarlandOn = true;
            lightsBtn.textContent = 'üí´ –ì–æ—Ä–∏—Ç—å';
            lightsBtn.classList.add('active');
            
            // –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '1.5');
            garlandLight.setAttribute('color', '#FFFF00');
            
            // –ó—Ä–æ–±–∏—Ç–∏ –≤–æ–≥–Ω–∏–∫–∏ –≤–∏–¥–∏–º–∏–º–∏ —Ç–∞ –∑–∞–ø–∞–ª–∏—Ç–∏
            lights.forEach((light, index) => {
                if (!light) return;
                
                // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä —Ç–∞ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å
                light.setAttribute('opacity', '1');
                light.setAttribute('color', '#FFFF00');
                light.setAttribute('emissive', '#FFFF00');
                light.setAttribute('emissive-intensity', '2');
                
                // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø—É–ª—å—Å–∞—Ü—ñ—ó
                const pulseAnim = document.createElement('a-animation');
                pulseAnim.setAttribute('attribute', 'scale');
                pulseAnim.setAttribute('from', '1 1 1');
                pulseAnim.setAttribute('to', '1.2 1.2 1.2');
                pulseAnim.setAttribute('dur', '800');
                pulseAnim.setAttribute('direction', 'alternate');
                pulseAnim.setAttribute('repeat', 'indefinite');
                pulseAnim.setAttribute('begin', index * 100 + 'ms');
                light.appendChild(pulseAnim);
                
                // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –º–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è
                const flickerAnim = document.createElement('a-animation');
                flickerAnim.setAttribute('attribute', 'emissive-intensity');
                flickerAnim.setAttribute('from', '1');
                flickerAnim.setAttribute('to', '3');
                flickerAnim.setAttribute('dur', '300');
                flickerAnim.setAttribute('direction', 'alternate');
                flickerAnim.setAttribute('repeat', 'indefinite');
                flickerAnim.setAttribute('begin', index * 150 + 'ms');
                light.appendChild(flickerAnim);
                
                // –í–∏–ø–∞–¥–∫–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –∫–æ–ª—å–æ—Ä—É
                const colorAnim = document.createElement('a-animation');
                colorAnim.setAttribute('attribute', 'color');
                colorAnim.setAttribute('from', '#FFFF00');
                colorAnim.setAttribute('to', '#FFA500');
                colorAnim.setAttribute('dur', '2000');
                colorAnim.setAttribute('direction', 'alternate');
                colorAnim.setAttribute('repeat', 'indefinite');
                colorAnim.setAttribute('begin', Math.random() * 1000 + 'ms');
                light.appendChild(colorAnim);
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
            voiceStatus.textContent = '–ì—ñ—Ä–ª—è–Ω–¥–∞ –≥–æ—Ä–∏—Ç—å!';
            voiceIndicator.classList.add('active');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–º–∫–Ω—É—Ç–∏ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (isGarlandOn) {
                    extinguishGarland();
                    voiceStatus.textContent = '–ì–æ—Ç–æ–≤–∏–π –¥–æ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è';
                    voiceIndicator.classList.remove('active');
                }
            }, 15000);
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏ (—Ä–æ–±–∏—Ç—å –≤–æ–≥–Ω–∏–∫–∏ –ø—Ä–æ–∑–æ—Ä–∏–º–∏)
        function extinguishGarland() {
            if (!isGarlandOn) return;
            
            console.log('üí° –í–∏–º–∫–Ω—É—Ç–∏ –≥—ñ—Ä–ª—è–Ω–¥—É');
            isGarlandOn = false;
            lightsBtn.textContent = '‚ú® –£–≤—ñ–º–∫–Ω—É—Ç–∏';
            lightsBtn.classList.remove('active');
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '0');
            
            // –†–æ–±–∏–º–æ –≤–æ–≥–Ω–∏–∫–∏ –ø—Ä–æ–∑–æ—Ä–∏–º–∏
            lights.forEach(light => {
                if (!light) return;
                light.setAttribute('opacity', '0.3');
                light.setAttribute('color', '#000000');
                light.setAttribute('emissive', '#000000');
                light.setAttribute('emissive-intensity', '0');
                
                // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const animations = light.querySelectorAll('a-animation');
                animations.forEach(anim => anim.remove());
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ –≥—ñ—Ä–ª—è–Ω–¥–∏ (–¥–ª—è cleanup)
        function stopGarland() {
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
            extinguishGarland();
        }

        // –§—É–Ω–∫—Ü—ñ—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é —á—É—Ç–ª–∏–≤—ñ—Å—Ç—é
        async function initMicrophone() {
            try {
                // –ó–∞–ø–∏—Ç—É—î–º–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω –∑ –æ–ø—Ç–∏–º–∞–ª—å–Ω–∏–º–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 44100,
                        channelCount: 1
                    } 
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(micStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256; // –ú–µ–Ω—à–µ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è —à–≤–∏–¥—à–æ—ó —Ä–µ–∞–∫—Ü—ñ—ó
                analyser.smoothingTimeConstant = 0.1; // –ú–µ–Ω—à–µ –∑–≥–ª–∞–¥–∂—É–≤–∞–Ω–Ω—è –¥–ª—è —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                micBtn.textContent = 'üé§ –°–ª—É—Ö–∞—î–º–æ...';
                micBtn.classList.add('active');
                isMicActive = true;
                voiceIndicator.classList.add('active');
                voiceStatus.textContent = '–°–ª—É—Ö–∞—î–º–æ... —Å–∫–∞–∂—ñ—Ç—å "–Ø–ª–∏–Ω–æ—á–∫–∞ –≥–æ—Ä–∏!"';
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –∞—É–¥—ñ–æ
                processAudio();
                
            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:', err);
                micBtn.textContent = 'üé§ –ü–æ–º–∏–ª–∫–∞';
                micBtn.classList.add('off');
                voiceStatus.textContent = '–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞';
                voiceIndicator.style.background = '#ff4444';
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        function stopMicrophone() {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) audioContext.close();
            analyser = null;
            micStream = null;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ UI
            micBtn.textContent = 'üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
            micBtn.classList.remove('active');
            isMicActive = false;
            voiceIndicator.classList.remove('active');
            voiceStatus.textContent = '–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –≤–∏–º–∫–Ω–µ–Ω–æ';
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –∞—É–¥—ñ–æ –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ–¥–∏—Ö—É/–≥–æ–ª–æ—Å—É
        function processAudio() {
            if (!analyser || !isMicActive) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // –û–±—á–∏—Å–ª—é—î–º–æ —Å–µ—Ä–µ–¥–Ω—é –≥—É—á–Ω—ñ—Å—Ç—å
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const avgVolume = sum / dataArray.length;
            
            // –î–∏–Ω–∞–º—ñ—á–Ω–∞ —ñ–Ω–¥–∏–∫–∞—Ü—ñ—è –≥—É—á–Ω–æ—Å—Ç—ñ
            const normalizedVolume = Math.min(100, Math.max(0, (avgVolume / 255) * 100));
            voiceIndicator.style.transform = `scale(${1 + normalizedVolume / 100})`;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ø–æ—Ä—ñ–≥ —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ
            const threshold = settings.sensitivity;
            
            if (avgVolume > threshold) {
                console.log('üé§ –í–∏—è–≤–ª–µ–Ω–æ –∑–≤—É–∫! –ì—É—á–Ω—ñ—Å—Ç—å:', avgVolume, '–ü–æ—Ä—ñ–≥:', threshold);
                
                // –Ø–∫—â–æ —Ü–µ –ø–æ–¥–∏—Ö/–≥–æ–ª–æ—Å (—Ä–∞–ø—Ç–æ–≤–µ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –≥—É—á–Ω–æ—Å—Ç—ñ)
                if (avgVolume > threshold + 10) {
                    if (!isGarlandOn) {
                        console.log('üî• –ü–æ–¥–∏—Ö/–≥–æ–ª–æ—Å –≤–∏—è–≤–ª–µ–Ω–æ! –ó–∞–ø–∞–ª—é—î–º–æ –≥—ñ—Ä–ª—è–Ω–¥—É');
                        igniteGarland();
                        
                        // –í—ñ–∑—É–∞–ª—å–Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
                        voiceStatus.textContent = '–í–∏—è–≤–ª–µ–Ω–æ –≥–æ–ª–æ—Å!';
                        voiceIndicator.style.background = '#4CAF50';
                        
                        // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∏–π —Å—Ç–∞–Ω —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                        setTimeout(() => {
                            if (isMicActive) {
                                voiceStatus.textContent = '–°–ª—É—Ö–∞—î–º–æ...';
                                voiceIndicator.style.background = '#4CAF50';
                            }
                        }, 1000);
                    }
                }
            }
            
            // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ–±—Ä–æ–±–∫—É
            requestAnimationFrame(processAudio);
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å–∫–∏–¥–∞–Ω–Ω—è UI
        function resetUI() {
            musicBtn.textContent = 'üéµ –ú—É–∑–∏–∫–∞';
            musicBtn.classList.remove('active', 'off');
            micBtn.textContent = 'üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
            micBtn.classList.remove('active', 'off');
            lightsBtn.textContent = '‚ú® –£–≤—ñ–º–∫–Ω—É—Ç–∏';
            lightsBtn.classList.remove('active');
            settingsBtn.textContent = '‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è';
            settingsBtn.classList.remove('active');
            
            voiceStatus.textContent = '–ú—ñ–∫—Ä–æ—Ñ–æ–Ω –≤–∏–º–∫–Ω–µ–Ω–æ';
            voiceIndicator.classList.remove('active');
            voiceIndicator.style.background = '#ff4444';
            voiceIndicator.style.transform = 'scale(1)';
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –º—É–∑–∏–∫–∏
        musicBtn.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play()
                    .then(() => {
                        musicBtn.textContent = 'üîá –ú—É–∑–∏–∫–∞';
                        musicBtn.classList.add('active');
                        isMusicPlaying = true;
                    })
                    .catch(e => {
                        console.log("üîá –ü–æ–º–∏–ª–∫–∞ –º—É–∑–∏–∫–∏:", e);
                        musicBtn.textContent = 'üéµ –ü–æ–º–∏–ª–∫–∞';
                        musicBtn.classList.add('off');
                    });
            } else {
                bgMusic.pause();
                musicBtn.textContent = 'üéµ –ú—É–∑–∏–∫–∞';
                musicBtn.classList.remove('active');
                isMusicPlaying = false;
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        micBtn.addEventListener('click', () => {
            if (!isMicActive) {
                initMicrophone();
            } else {
                stopMicrophone();
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤–æ–≥–Ω—ñ–≤
        lightsBtn.addEventListener('click', () => {
            if (!isGarlandOn) {
                igniteGarland();
            } else {
                extinguishGarland();
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        settingsBtn.addEventListener('click', () => {
            const isShowing = settingsPanel.style.display === 'block';
            settingsPanel.style.display = isShowing ? 'none' : 'block';
            settingsBtn.classList.toggle('active', !isShowing);
            settingsBtn.textContent = isShowing ? '‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è' : '‚úñÔ∏è –ó–∞–∫—Ä–∏—Ç–∏';
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Å–ª–∞–π–¥–µ—Ä—ñ–≤
        sensitivitySlider.addEventListener('input', (e) => {
            settings.sensitivity = parseInt(e.target.value);
            sensitivityValue.textContent = settings.sensitivity;
        });

        heightSlider.addEventListener('input', (e) => {
            settings.height = parseInt(e.target.value) * 0.01; // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ 0-100 –≤ 0-1
            heightValue.textContent = Math.round(settings.height * 100 / 0.01);
        });

        sizeSlider.addEventListener('input', (e) => {
            settings.size = parseInt(e.target.value) / 100; // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ % –≤ 0.1-2.0
            sizeValue.textContent = Math.round(settings.size * 100) + '%';
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Ä–∞–¥—ñ–æ-–∫–Ω–æ–ø–æ–∫ —Ç–∏–ø—É –º–∞—Ä–∫–µ—Ä–∞
        markerTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                settings.markerType = e.target.value;
            });
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        applySettingsBtn.addEventListener('click', applySettings);

        // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') { // –ü—Ä–æ–±—ñ–ª - —É–≤—ñ–º–∫/–≤–∏–º–∫
                if (!lightsBtn.disabled) {
                    if (!isGarlandOn) {
                        igniteGarland();
                    } else {
                        extinguishGarland();
                    }
                }
            } else if (e.key === 'm' || e.key === 'M') { // M - –º—É–∑–∏–∫–∞
                musicBtn.click();
            } else if (e.key === 's' || e.key === 'S') { // S - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                settingsBtn.click();
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        window.addEventListener('beforeunload', () => {
            stopMicrophone();
            stopGarland();
            if (bgMusic) bgMusic.pause();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –º—É–∑–∏–∫–∏
        bgMusic.addEventListener('canplay', () => {
            console.log('üéµ –ú—É–∑–∏–∫–∞ –≥–æ—Ç–æ–≤–∞');
        });

        bgMusic.addEventListener('error', (e) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –º—É–∑–∏–∫–∏:', e);
            musicBtn.textContent = 'üéµ –ù–µ–º–∞—î —Ñ–∞–π–ª—É';
            musicBtn.classList.add('off');
            musicBtn.disabled = true;
        });

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å
        function fixHeight() {
            document.body.style.height = window.innerHeight + 'px';
        }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        console.log('üöÄ AR –ì—ñ—Ä–ª—è–Ω–¥–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!');
        updateSliderValues();
    </script>
</body>
</html>
