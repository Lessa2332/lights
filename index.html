<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR –≥—ñ—Ä–ª—è–Ω–¥–∞ –∑ –≥–æ–ª–æ—Å–æ–≤–∏–º –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º">
    <title>üéÑ AR –ì—ñ—Ä–ª—è–Ω–¥–∞</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Arial', sans-serif;
            touch-action: none;
        }
        
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0c2461, #1e3799);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffd700;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .loader h1 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .loader p {
            font-size: 1.1em;
            margin: 8px 0;
            opacity: 0.9;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
            font-size: 4em;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }

        /* –ì–æ–ª–æ–≤–Ω—ñ –∫–Ω–æ–ø–∫–∏ */
        .main-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 95%;
        }

        .main-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 30px;
            background: linear-gradient(145deg, #4a69bd, #3c538f);
            color: white;
            font-size: 0.95em;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            min-width: 150px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .main-btn:hover {
            background: linear-gradient(145deg, #5a79cd, #4c638f);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        .main-btn:active {
            transform: translateY(0);
        }

        .main-btn.active {
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            color: white;
            border-color: #81C784;
        }

        .main-btn.off {
            background: linear-gradient(145deg, #f44336, #d32f2f);
            border-color: #ef5350;
        }

        /* –ü–∞–Ω–µ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
        .settings-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: none;
            max-width: 300px;
        }

        .settings-group {
            margin-bottom: 15px;
        }

        .settings-group h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
            font-size: 1.1em;
        }

        .setting-option {
            display: flex;
            align-items: center;
            margin: 8px 0;
            cursor: pointer;
        }

        .setting-option input[type="radio"] {
            margin-right: 10px;
        }

        .slider-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .slider-container label {
            margin-right: 10px;
            min-width: 100px;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .value-display {
            margin-left: 10px;
            min-width: 30px;
            text-align: center;
            color: #ffd700;
        }

        /* –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å */
        .info-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 15px;
            border-radius: 20px;
            max-width: 300px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 215, 0, 0.3);
            display: none;
        }

        .info-panel h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
            font-size: 1.1em;
        }

        .info-panel p {
            margin: 5px 0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .voice-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            background: #ff4444;
            animation: voicePulse 1s infinite;
        }

        @keyframes voicePulse {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .voice-indicator.active {
            background: #4CAF50;
            animation: voiceActive 0.5s infinite alternate;
        }

        @keyframes voiceActive {
            0% { opacity: 0.5; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.3); }
        }

        /* –°–ø—ñ—á-–±–∞–±–ª */
        .speech-bubble {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            border: 2px solid #ffd700;
            z-index: 10001;
            display: none;
            font-size: 1.1em;
            backdrop-filter: blur(10px);
            max-width: 80%;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .main-controls {
                bottom: 15px;
                gap: 10px;
            }
            
            .main-btn {
                padding: 12px 20px;
                font-size: 0.9em;
                min-width: 130px;
            }
            
            .settings-panel,
            .info-panel {
                top: 15px;
                left: 15px;
                right: 15px;
                max-width: none;
                width: calc(100% - 30px);
            }
            
            .loader h1 {
                font-size: 1.5em;
            }
            
            .pulse {
                font-size: 3em;
            }
            
            .speech-bubble {
                top: 70px;
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .main-controls {
                flex-direction: column;
                align-items: center;
                gap: 8px;
                bottom: 10px;
            }
            
            .main-btn {
                width: 90%;
                max-width: 280px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class="loader" id="loader">
        <div class="pulse">‚ú®</div>
        <h1>AR –ì—ñ—Ä–ª—è–Ω–¥–∞</h1>
        <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
        <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">–ó–∞—á–µ–∫–∞–π—Ç–µ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</p>
    </div>
    
    <!-- –°–ø—ñ—á-–±–∞–±–ª –¥–ª—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏ -->
    <div class="speech-bubble" id="speech-bubble"></div>
    
    <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ –ø–∞–Ω–µ–ª—å -->
    <div class="info-panel" id="info-panel">
        <h3>üé§ –ì–æ–ª–æ—Å–æ–≤–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è</h3>
        <p><span class="voice-indicator" id="voice-indicator"></span> <span id="voice-status">–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ</span></p>
        <p>üó£Ô∏è –°–∫–∞–∂—ñ—Ç—å –≥–æ–ª–æ—Å–Ω–æ:</p>
        <p><strong>"–Ø–ª–∏–Ω–æ—á–∫–∞"</strong> - —É–≤—ñ–º–∫–Ω—É—Ç–∏/–≤–∏–º–∫–Ω—É—Ç–∏</p>
        <p><strong>"–ì—ñ—Ä–ª—è–Ω–¥–∞"</strong> - –∑–º—ñ–Ω–∏—Ç–∏ —Ä–µ–∂–∏–º</p>
        <p><strong>"–ù–æ–≤–æ—Ä—ñ—á–Ω–∞"</strong> - —Å–ø–µ—Ü–µ—Ñ–µ–∫—Ç–∏</p>
        <p style="margin-top: 10px; color: #ffd700;">üí° –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 15—Å</p>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-group">
            <h3>üìê –†–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞</h3>
            <label class="setting-option">
                <input type="radio" name="marker-type" value="table" checked>
                <span>–ù–∞ —Å—Ç–æ–ª—ñ (–ª–µ–∂–∏—Ç—å)</span>
            </label>
            <label class="setting-option">
                <input type="radio" name="marker-type" value="wall">
                <span>–ù–∞ —Å—Ç—ñ–Ω—ñ (–≤–∏—Å–∏—Ç—å)</span>
            </label>
        </div>
        
        <div class="settings-group">
            <h3>üéõÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–æ–≤–∏</h3>
            <div class="slider-container">
                <label>–ß—É—Ç–ª–∏–≤—ñ—Å—Ç—å:</label>
                <input type="range" id="sensitivity-slider" min="1" max="10" value="5">
                <span class="value-display" id="sensitivity-value">5</span>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>üîß –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≤–æ–≥–Ω–∏–∫—ñ–≤</h3>
            <div class="slider-container">
                <label>–í–∏—Å–æ—Ç–∞:</label>
                <input type="range" id="height-slider" min="1" max="50" value="5">
                <span class="value-display" id="height-value">5 —Å–º</span>
            </div>
            <div class="slider-container">
                <label>–†–æ–∑–º—ñ—Ä:</label>
                <input type="range" id="size-slider" min="10" max="200" value="100">
                <span class="value-display" id="size-value">100%</span>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>‚ú® –ï—Ñ–µ–∫—Ç–∏</h3>
            <label class="setting-option">
                <input type="checkbox" id="chasing-effect" checked>
                <span>–ë—ñ–≥–∞—é—á—ñ –≤–æ–≥–Ω–∏–∫–∏</span>
            </label>
            <label class="setting-option">
                <input type="checkbox" id="snow-effect" checked>
                <span>–°–Ω—ñ–≥–æ–ø–∞–¥</span>
            </label>
        </div>
        
        <button id="apply-settings" class="main-btn" style="width: 100%; margin-top: 10px; padding: 10px;">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
    </div>

    <!-- A-Frame —Å—Ü–µ–Ω–∞ -->
    <a-scene
        mindar-image="imageTargetSrc: marcher.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="bg-music" src="music.mp3" preload="auto"></audio>
            <audio id="ignite-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-magic-sparkle-300.mp3" preload="auto"></audio>
            <audio id="extinguish-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-candle-blowing-302.mp3" preload="auto"></audio>
        </a-assets>

        <a-camera
            id="camera"
            position="0 0 1.5"
            look-controls="enabled: true"
        ></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—ñ—Ä–ª—è–Ω–¥–∏ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—é –æ—Ä—ñ—î–Ω—Ç–∞—Ü—ñ—î—é -->
            <a-entity id="garland-container" rotation="0 0 0" position="0 0.05 0" scale="1 1 1">
                <!-- 7 –∫—É–ª—å–æ–∫ –≥—ñ—Ä–ª—è–Ω–¥–∏ —É —Ñ–æ—Ä–º—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ -->
                <!-- –†—è–¥ 1 (–≤–µ—Ä—Ö–Ω—ñ–π) -->
                <a-sphere id="light1" class="garland-light" position="0 0.27 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 2 -->
                <a-sphere id="light2" class="garland-light" position="-0.15 0.12 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light3" class="garland-light" position="0.15 0.12 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 3 -->
                <a-sphere id="light4" class="garland-light" position="-0.25 -0.03 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light5" class="garland-light" position="0.25 -0.03 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 4 (–Ω–∏–∂–Ω—ñ–π) -->
                <a-sphere id="light6" class="garland-light" position="-0.1 -0.18 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light7" class="garland-light" position="0.1 -0.18 0" 
                    radius="0.04" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –°–Ω—ñ–≥–æ–ø–∞–¥ (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) -->
                <a-entity id="snow-container" position="0 0.2 0" visible="false">
                    <a-entity particle-system="preset: snow; 
                                               color: #ffffff,#ccccff,#e6e6ff; 
                                               particleCount: 600; 
                                               velocityValue: 0 0.4 0; 
                                               velocitySpread: 1.5 0.2 1.5; 
                                               opacity: 0.7; 
                                               size: 0.015 0.06; 
                                               accelerationValue: 0 -1.5 0;
                                               blending: additive"></a-entity>
                </a-entity>
                
                <!-- –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –≥—ñ—Ä–ª—è–Ω–¥–∏ -->
                <a-light id="garland-light" type="point" color="#FFD700" intensity="0" distance="2" position="0 0 0"></a-light>
                
                <!-- –î–æ–¥–∞—Ç–∫–æ–≤—ñ –µ—Ñ–µ–∫—Ç–∏ —Å–≤—ñ—Ç—ñ–Ω–Ω—è -->
                <a-light id="ambient-glow" type="ambient" color="#FFD700" intensity="0"></a-light>
            </a-entity>
        </a-entity>
    </a-scene>

    <!-- –ì–æ–ª–æ–≤–Ω—ñ –∫–Ω–æ–ø–∫–∏ -->
    <div class="main-controls">
        <button id="music-btn" class="main-btn">üéµ –ú—É–∑–∏–∫–∞</button>
        <button id="mic-btn" class="main-btn">üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è</button>
        <button id="lights-btn" class="main-btn" disabled>‚ú® –£–≤—ñ–º–∫–Ω—É—Ç–∏</button>
        <button id="settings-btn" class="main-btn">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
    </div>

    <script>
        // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
        const loader = document.getElementById('loader');
        const infoPanel = document.getElementById('info-panel');
        const voiceIndicator = document.getElementById('voice-indicator');
        const voiceStatus = document.getElementById('voice-status');
        const speechBubble = document.getElementById('speech-bubble');
        const settingsPanel = document.getElementById('settings-panel');
        const targetEntity = document.querySelector('[mindar-image-target]');
        const garlandContainer = document.getElementById('garland-container');
        const snowContainer = document.getElementById('snow-container');
        const musicBtn = document.getElementById('music-btn');
        const micBtn = document.getElementById('mic-btn');
        const lightsBtn = document.getElementById('lights-btn');
        const settingsBtn = document.getElementById('settings-btn');
        const bgMusic = document.getElementById('bg-music');
        const igniteSound = document.getElementById('ignite-sound');
        const extinguishSound = document.getElementById('extinguish-sound');
        const garlandLight = document.getElementById('garland-light');
        const ambientGlow = document.getElementById('ambient-glow');
        const applySettingsBtn = document.getElementById('apply-settings');
        
        // –ï–ª–µ–º–µ–Ω—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        const sensitivitySlider = document.getElementById('sensitivity-slider');
        const sensitivityValue = document.getElementById('sensitivity-value');
        const heightSlider = document.getElementById('height-slider');
        const heightValue = document.getElementById('height-value');
        const sizeSlider = document.getElementById('size-slider');
        const sizeValue = document.getElementById('size-value');
        const markerTypeRadios = document.querySelectorAll('input[name="marker-type"]');
        const chasingEffectCheckbox = document.getElementById('chasing-effect');
        const snowEffectCheckbox = document.getElementById('snow-effect');
        
        // –ú–∞—Å–∏–≤ –∑ 7 –∫—É–ª—å–∫–∞–º–∏
        const lights = Array.from(document.querySelectorAll('.garland-light'));
        
        // –ó–º—ñ–Ω–Ω—ñ —Å—Ç–∞–Ω—É
        let isMusicPlaying = false;
        let isSpeechRecognitionActive = false;
        let isGarlandOn = false;
        let garlandTimeout = null;
        let speechRecognition = null;
        let chasingLightsInterval = null;
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        let settings = {
            markerType: 'table', // 'table' –∞–±–æ 'wall'
            sensitivity: 5,      // —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è (1-10)
            height: 0.05,        // –≤–∏—Å–æ—Ç–∞ –≤–æ–≥–Ω–∏–∫—ñ–≤ –≤ –º–µ—Ç—Ä–∞—Ö (0.01-0.5–º)
            size: 1.0,           // —Ä–æ–∑–º—ñ—Ä –≤–æ–≥–Ω–∏–∫—ñ–≤ (0.1-2.0)
            chasingEffect: true, // –±—ñ–≥–∞—é—á—ñ –≤–æ–≥–Ω–∏–∫–∏
            snowEffect: true     // —Å–Ω—ñ–≥–æ–ø–∞–¥
        };
        
        // –§—É–Ω–∫—Ü—ñ—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–Ω–∞—á–µ–Ω—å —Å–ª–∞–π–¥–µ—Ä—ñ–≤
        function updateSliderValues() {
            sensitivityValue.textContent = settings.sensitivity;
            heightValue.textContent = Math.round(settings.height * 100) + ' —Å–º';
            sizeValue.textContent = Math.round(settings.size * 100) + '%';
            chasingEffectCheckbox.checked = settings.chasingEffect;
            snowEffectCheckbox.checked = settings.snowEffect;
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        function applySettings() {
            console.log('–ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:', settings);
            
            const container = garlandContainer;
            
            if (settings.markerType === 'wall') {
                // –ú–∞—Ä–∫–µ—Ä –Ω–∞ —Å—Ç—ñ–Ω—ñ ‚Üí –≥—ñ—Ä–ª—è–Ω–¥–∞ –≤–∏—Å–∏—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ, –ø—Ä—è–º–æ –Ω–∞–¥ –º–∞—Ä–∫–µ—Ä–æ–º
                container.setAttribute('rotation', '-90 0 0');    // –ø–µ—Ä–µ–≤–µ—Ä—Ç–∞—î–º–æ –Ω–∞ 90¬∞ –ø–æ X
                container.setAttribute('position', `0 0 ${settings.height}`); // –ø—ñ–¥–Ω—ñ–º–∞—î–º–æ –ø–æ Z (–≤–≥–æ—Ä—É –≤—ñ–¥ —Å—Ç—ñ–Ω–∏)
            } else {
                // –ú–∞—Ä–∫–µ—Ä –Ω–∞ —Å—Ç–æ–ª—ñ ‚Üí –≥—ñ—Ä–ª—è–Ω–¥–∞ –ª–µ–∂–∏—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, —Ç—Ä–æ—Ö–∏ –≤–∏—â–µ
                container.setAttribute('rotation', '0 0 0');      // —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –ø–æ–ª–æ–∂–µ–Ω–Ω—è
                container.setAttribute('position', `0 ${settings.height} 0`); // –ø—ñ–¥–Ω—ñ–º–∞—î–º–æ –ø–æ Y
            }
            
            // –†–æ–∑–º—ñ—Ä
            container.setAttribute('scale', `${settings.size} ${settings.size} ${settings.size}`);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –≤–ø–ª–∏–≤ –Ω–∞ —Å–Ω—ñ–≥
            if (snowContainer) {
                snowContainer.setAttribute('visible', settings.snowEffect && isGarlandOn);
            }
            
            updateSliderValues();
            settingsPanel.style.display = 'none';
            settingsBtn.textContent = '‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è';
            settingsBtn.classList.remove('active');
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                console.error('–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ');
                micBtn.textContent = 'üé§ –ù–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è';
                micBtn.classList.add('off');
                voiceStatus.textContent = '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î';
                return null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'uk-UA';
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxAlternatives = 3;
            
            recognition.onstart = () => {
                console.log('üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ');
                micBtn.textContent = 'üé§ –°–ª—É—Ö–∞—î–º–æ...';
                micBtn.classList.add('active');
                isSpeechRecognitionActive = true;
                voiceIndicator.classList.add('active');
                voiceStatus.textContent = '–°–ª—É—Ö–∞—é... —Å–∫–∞–∂—ñ—Ç—å "–Ø–ª–∏–Ω–æ—á–∫–∞"';
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                console.log('üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ:', transcript);
                
                // –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø—ñ—á-–±–∞–±–ª
                showSpeechBubble(transcript);
                
                // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–ª—é—á–æ–≤—ñ —Å–ª–æ–≤–∞
                if (transcript.includes('—è–ª–∏–Ω–æ—á–∫–∞')) {
                    console.log('üî• –ö–æ–º–∞–Ω–¥–∞ "–Ø–ª–∏–Ω–æ—á–∫–∞" –æ—Ç—Ä–∏–º–∞–Ω–∞!');
                    if (!isGarlandOn) {
                        igniteGarland();
                    } else {
                        extinguishGarland();
                    }
                } else if (transcript.includes('–≥—ñ—Ä–ª—è–Ω–¥–∞')) {
                    console.log('‚ú® –ö–æ–º–∞–Ω–¥–∞ "–ì—ñ—Ä–ª—è–Ω–¥–∞" –æ—Ç—Ä–∏–º–∞–Ω–∞!');
                    if (isGarlandOn) {
                        changeLightMode();
                    }
                } else if (transcript.includes('–Ω–æ–≤–æ—Ä—ñ—á–Ω–∞')) {
                    console.log('üéÑ –ö–æ–º–∞–Ω–¥–∞ "–ù–æ–≤–æ—Ä—ñ—á–Ω–∞" –æ—Ç—Ä–∏–º–∞–Ω–∞!');
                    triggerSpecialEffects();
                }
            };
            
            recognition.onerror = (event) => {
                console.error('–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏:', event.error);
                if (event.error === 'not-allowed') {
                    voiceStatus.textContent = '–î–æ–∑–≤—ñ–ª –Ω–µ –Ω–∞–¥–∞–Ω–æ';
                    micBtn.textContent = 'üé§ –î–æ–∑–≤—ñ–ª –ø–æ—Ç—Ä—ñ–±–µ–Ω';
                    micBtn.classList.add('off');
                } else if (event.error === 'network') {
                    voiceStatus.textContent = '–ú–µ—Ä–µ–∂–µ–≤–∞ –ø–æ–º–∏–ª–∫–∞';
                }
                stopSpeechRecognition();
            };
            
            recognition.onend = () => {
                console.log('üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
                if (isSpeechRecognitionActive) {
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—î–º–æ, —è–∫—â–æ –Ω–µ –±—É–ª–æ –ø–æ–º–∏–ª–∫–∏
                    setTimeout(() => {
                        if (isSpeechRecognitionActive) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log('–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è');
                            }
                        }
                    }, 100);
                }
            };
            
            return recognition;
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∞–∑—É —Å–ø—ñ—á-–±–∞–±–ª–∞
        function showSpeechBubble(text) {
            speechBubble.textContent = `"${text}"`;
            speechBubble.style.display = 'block';
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
            clearTimeout(speechBubble.timeout);
            speechBubble.timeout = setTimeout(() => {
                speechBubble.style.display = 'none';
            }, 2000);
        }
        
        // –§—É–Ω–∫—Ü—ñ—è —Å—Ç–∞—Ä—Ç—É —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏
        function startSpeechRecognition() {
            if (!speechRecognition) {
                speechRecognition = initSpeechRecognition();
            }
            
            if (speechRecognition) {
                try {
                    speechRecognition.start();
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ —Å—Ç–∞—Ä—Ç—É —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:', e);
                }
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏
        function stopSpeechRecognition() {
            isSpeechRecognitionActive = false;
            if (speechRecognition) {
                try {
                    speechRecognition.stop();
                } catch (e) {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –∑—É–ø–∏–Ω–∫–∏ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è:', e);
                }
            }
            
            micBtn.textContent = 'üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è';
            micBtn.classList.remove('active');
            voiceIndicator.classList.remove('active');
            voiceStatus.textContent = '–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ';
        }
        
        // –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
                loader.style.display = 'none';
                if (garlandContainer) {
                    garlandContainer.setAttribute('visible', 'true');
                }
                // –ü–æ–∫–∞–∑—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—É –ø–∞–Ω–µ–ª—å
                infoPanel.style.display = 'block';
                lightsBtn.disabled = false;
                
                // –ó–∞–ø–∏—Ç—É—î–º–æ –¥–æ–∑–≤—ñ–ª –Ω–∞ –≥—ñ—Ä–æ—Å–∫–æ–ø –¥–ª—è iOS
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                console.log('–î–æ–∑–≤—ñ–ª –Ω–∞ –≥—ñ—Ä–æ—Å–∫–æ–ø –æ—Ç—Ä–∏–º–∞–Ω–æ');
                            }
                        })
                        .catch(console.error);
                }
                
                // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                applySettings();
            });

            targetEntity.addEventListener('targetLost', () => {
                console.log("‚ÑπÔ∏è –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ.");
                if (garlandContainer) {
                    garlandContainer.setAttribute('visible', 'false');
                }
                // –í–∏–º–∏–∫–∞—î–º–æ –≤—Å–µ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
                stopGarland();
                if (bgMusic && !bgMusic.paused) bgMusic.pause();
                stopSpeechRecognition();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                loader.style.display = 'flex';
                infoPanel.style.display = 'none';
                settingsPanel.style.display = 'none';
                speechBubble.style.display = 'none';
                resetUI();
                lightsBtn.disabled = true;
                
                // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω–∏
                isMusicPlaying = false;
                isSpeechRecognitionActive = false;
                isGarlandOn = false;
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø—É—Å–∫—É –±—ñ–≥–∞—é—á–∏—Ö –≤–æ–≥–Ω–∏–∫—ñ–≤
        function startChasingLights() {
            if (chasingLightsInterval) {
                clearInterval(chasingLightsInterval);
            }
            
            let runningIndex = 0;
            chasingLightsInterval = setInterval(() => {
                if (!isGarlandOn || !settings.chasingEffect) {
                    clearInterval(chasingLightsInterval);
                    return;
                }
                
                lights.forEach((l, i) => {
                    if (l) {
                        // –û—Å–≤—ñ—Ç–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –∫—É–ª—å–∫—É, —ñ–Ω—à—ñ —Ä–æ–±–∏–º–æ —Ç—å–º—è–Ω—ñ—à–∏–º–∏
                        if (i === runningIndex) {
                            l.setAttribute('emissive-intensity', '4');
                            l.setAttribute('scale', '1.15 1.15 1.15');
                        } else {
                            l.setAttribute('emissive-intensity', '1.2');
                            l.setAttribute('scale', '1 1 1');
                        }
                    }
                });
                
                runningIndex = (runningIndex + 1) % lights.length;
            }, 200); // –®–≤–∏–¥–∫—ñ—Å—Ç—å –±—ñ–≥–∞–Ω–Ω—è –≤–æ–≥–Ω–∏–∫—ñ–≤
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏
        function igniteGarland() {
            if (isGarlandOn) return;
            
            console.log('‚ú® –ó–∞–ø–∞–ª—é—î–º–æ –≥—ñ—Ä–ª—è–Ω–¥—É!');
            isGarlandOn = true;
            lightsBtn.textContent = 'üí´ –ì–æ—Ä–∏—Ç—å';
            lightsBtn.classList.add('active');
            
            // –ó–≤—É–∫ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è
            if (igniteSound) {
                igniteSound.currentTime = 0;
                igniteSound.play().catch(e => console.log('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫'));
            }
            
            // –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '2.0');
            garlandLight.setAttribute('color', '#FFD700');
            ambientGlow.setAttribute('intensity', '0.3');
            
            // –ë—ñ–ª—å—à —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–æ–≥–Ω–∏–∫—ñ–≤
            const fireColors = ['#FFFF00', '#FFA500', '#FF4500', '#FFD700', '#FF8C00'];
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤–æ–≥–Ω–∏–∫—ñ–≤
            lights.forEach((light, index) => {
                if (!light) return;
                
                // –í–∏–ø–∞–¥–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä –≤–æ–≥–Ω–∏–∫–∞
                const color = fireColors[Math.floor(Math.random() * fireColors.length)];
                
                // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä —Ç–∞ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å
                light.setAttribute('opacity', '1');
                light.setAttribute('color', color);
                light.setAttribute('emissive', color);
                light.setAttribute('emissive-intensity', '3');
                light.setAttribute('scale', '1 1 1'); // –°–∫–∏–¥–∞—î–º–æ –º–∞—Å—à—Ç–∞–±
                
                // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const oldAnims = light.querySelectorAll('a-animation');
                oldAnims.forEach(anim => anim.remove());
                
                // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –ø—É–ª—å—Å–∞—Ü—ñ—ó
                const pulseAnim = document.createElement('a-animation');
                pulseAnim.setAttribute('attribute', 'scale');
                pulseAnim.setAttribute('from', '1 1 1');
                pulseAnim.setAttribute('to', '1.1 1.1 1.1');
                pulseAnim.setAttribute('dur', '1000 + Math.random() * 500');
                pulseAnim.setAttribute('direction', 'alternate');
                pulseAnim.setAttribute('repeat', 'indefinite');
                pulseAnim.setAttribute('begin', index * 150 + 'ms');
                light.appendChild(pulseAnim);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –º–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è (—ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å)
                const flickerAnim = document.createElement('a-animation');
                flickerAnim.setAttribute('attribute', 'emissive-intensity');
                flickerAnim.setAttribute('from', '2');
                flickerAnim.setAttribute('to', '3.5');
                flickerAnim.setAttribute('dur', '200 + Math.random() * 300');
                flickerAnim.setAttribute('direction', 'alternate');
                flickerAnim.setAttribute('repeat', 'indefinite');
                flickerAnim.setAttribute('begin', Math.random() * 1000 + 'ms');
                light.appendChild(flickerAnim);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –∫–æ–ª—å–æ—Ä—É (–¥–ª—è –µ—Ñ–µ–∫—Ç—É –ø–æ–ª—É–º'—è)
                const colorAnim = document.createElement('a-animation');
                colorAnim.setAttribute('attribute', 'color');
                colorAnim.setAttribute('from', color);
                colorAnim.setAttribute('to', fireColors[(index + 1) % fireColors.length]);
                colorAnim.setAttribute('dur', '1500 + Math.random() * 1000');
                colorAnim.setAttribute('direction', 'alternate');
                colorAnim.setAttribute('repeat', 'indefinite');
                colorAnim.setAttribute('begin', Math.random() * 500 + 'ms');
                light.appendChild(colorAnim);
            });
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –±—ñ–≥–∞—é—á—ñ –≤–æ–≥–Ω–∏–∫–∏, —è–∫—â–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ
            if (settings.chasingEffect) {
                startChasingLights();
            }
            
            // –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–Ω—ñ–≥–æ–ø–∞–¥, —è–∫—â–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ
            if (settings.snowEffect && snowContainer) {
                snowContainer.setAttribute('visible', 'true');
            }
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
            voiceStatus.textContent = '–ì—ñ—Ä–ª—è–Ω–¥–∞ –≥–æ—Ä–∏—Ç—å!';
            voiceIndicator.classList.add('active');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥
            clearTimeout(garlandTimeout);
            garlandTimeout = setTimeout(() => {
                if (isGarlandOn) {
                    extinguishGarland();
                    voiceStatus.textContent = '–ì–æ—Ç–æ–≤–∏–π –¥–æ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è';
                    voiceIndicator.classList.remove('active');
                }
            }, 15000);
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–º—ñ–Ω–∏ —Ä–µ–∂–∏–º—É –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è
        function changeLightMode() {
            console.log('üîÑ –ó–º—ñ–Ω—é—î–º–æ —Ä–µ–∂–∏–º –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è');
            
            const modes = [
                { color: '#FFD700', intensity: 2 }, // –ó–æ–ª–æ—Ç–∞
                { color: '#00FF00', intensity: 1.5 }, // –ó–µ–ª–µ–Ω–∞
                { color: '#FF0000', intensity: 2 }, // –ß–µ—Ä–≤–æ–Ω–∞
                { color: '#00FFFF', intensity: 1.8 }, // –ë–ª–∞–∫–∏—Ç–Ω–∞
                { color: '#FF00FF', intensity: 2 } // –§—ñ–æ–ª–µ—Ç–æ–≤–∞
            ];
            
            let currentMode = parseInt(localStorage.getItem('lightMode') || '0');
            currentMode = (currentMode + 1) % modes.length;
            localStorage.setItem('lightMode', currentMode);
            
            const mode = modes[currentMode];
            garlandLight.setAttribute('color', mode.color);
            garlandLight.setAttribute('intensity', mode.intensity);
            ambientGlow.setAttribute('color', mode.color);
            
            // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—å–æ—Ä–∏ –≤–æ–≥–Ω–∏–∫—ñ–≤
            lights.forEach(light => {
                if (!light) return;
                light.setAttribute('color', mode.color);
                light.setAttribute('emissive', mode.color);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –∫–æ–ª—å–æ—Ä—É
                const colorAnim = light.querySelector('a-animation[attribute="color"]');
                if (colorAnim) {
                    colorAnim.setAttribute('from', mode.color);
                    // –¢—Ä–æ—Ö–∏ —Ç–µ–º–Ω—ñ—à–∏–π –≤—ñ–¥—Ç—ñ–Ω–æ–∫ –¥–ª—è "to"
                    const darkerColor = darkenColor(mode.color, 20);
                    colorAnim.setAttribute('to', darkerColor);
                }
            });
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const modeNames = ['–ó–æ–ª–æ—Ç–∞', '–ó–µ–ª–µ–Ω–∞', '–ß–µ—Ä–≤–æ–Ω–∞', '–ë–ª–∞–∫–∏—Ç–Ω–∞', '–§—ñ–æ–ª–µ—Ç–æ–≤–∞'];
            showSpeechBubble(`–†–µ–∂–∏–º: ${modeNames[currentMode]}`);
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–Ω—è –∫–æ–ª—å–æ—Ä—É
        function darkenColor(color, percent) {
            const num = parseInt(color.slice(1), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) - amt;
            const G = (num >> 8 & 0x00FF) - amt;
            const B = (num & 0x0000FF) - amt;
            return '#' + (0x1000000 + (R < 0 ? 0 : R > 255 ? 255 : R) * 0x10000 +
                (G < 0 ? 0 : G > 255 ? 255 : G) * 0x100 +
                (B < 0 ? 0 : B > 255 ? 255 : B)).toString(16).slice(1);
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å–ø–µ—Ü–µ—Ñ–µ–∫—Ç—ñ–≤
        function triggerSpecialEffects() {
            console.log('üéÑ –ê–∫—Ç–∏–≤—É—î–º–æ —Å–ø–µ—Ü–µ—Ñ–µ–∫—Ç–∏!');
            
            // –ú–µ—Ä–µ—Ö—Ç–ª–∏–≤—ñ –µ—Ñ–µ–∫—Ç–∏
            let flashCount = 0;
            const flashInterval = setInterval(() => {
                if (flashCount >= 6) {
                    clearInterval(flashInterval);
                    return;
                }
                
                // –®–≤–∏–¥–∫–µ –º–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è
                garlandLight.setAttribute('intensity', flashCount % 2 === 0 ? '3' : '1');
                flashCount++;
            }, 200);
            
            // –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—ñ–≤ —Ä–∞–ø—Ç–æ–≤–æ
            setTimeout(() => {
                lights.forEach((light, index) => {
                    if (!light) return;
                    const colors = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF'];
                    light.setAttribute('color', colors[index % colors.length]);
                    light.setAttribute('emissive', colors[index % colors.length]);
                });
            }, 1200);
            
            // –ë—ñ–≥–∞—é—á—ñ –≤–æ–≥–Ω–∏–∫–∏ –Ω–∞ –≤–∏—Å–æ–∫—ñ–π —à–≤–∏–¥–∫–æ—Å—Ç—ñ
            if (settings.chasingEffect) {
                setTimeout(() => {
                    const fastInterval = setInterval(() => {
                        if (!isGarlandOn) {
                            clearInterval(fastInterval);
                            return;
                        }
                        
                        lights.forEach((l, i) => {
                            if (l) {
                                const randomBright = Math.random() > 0.5 ? '5' : '1';
                                l.setAttribute('emissive-intensity', randomBright);
                            }
                        });
                    }, 100);
                    
                    // –ó—É–ø–∏–Ω–∏—Ç–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏
                    setTimeout(() => {
                        clearInterval(fastInterval);
                        if (isGarlandOn && settings.chasingEffect) {
                            startChasingLights();
                        }
                    }, 3000);
                }, 1500);
            }
            
            // –ü–æ—Å–∏–ª–∏—Ç–∏ —Å–Ω—ñ–≥–æ–ø–∞–¥
            if (settings.snowEffect && snowContainer) {
                const particleSystem = snowContainer.querySelector('[particle-system]');
                if (particleSystem) {
                    particleSystem.setAttribute('particle-system', 'particleCount', '1200');
                    particleSystem.setAttribute('particle-system', 'velocityValue', '0 0.8 0');
                    
                    setTimeout(() => {
                        particleSystem.setAttribute('particle-system', 'particleCount', '600');
                        particleSystem.setAttribute('particle-system', 'velocityValue', '0 0.4 0');
                    }, 2000);
                }
            }
            
            showSpeechBubble('–ù–æ–≤–æ—Ä—ñ—á–Ω—ñ —Å–ø–µ—Ü–µ—Ñ–µ–∫—Ç–∏!');
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏
        function extinguishGarland() {
            if (!isGarlandOn) return;
            
            console.log('üí° –í–∏–º–∫–Ω—É—Ç–∏ –≥—ñ—Ä–ª—è–Ω–¥—É');
            isGarlandOn = false;
            lightsBtn.textContent = '‚ú® –£–≤—ñ–º–∫–Ω—É—Ç–∏';
            lightsBtn.classList.remove('active');
            
            // –ó–≤—É–∫ –≤–∏–º–∫–Ω–µ–Ω–Ω—è
            if (extinguishSound) {
                extinguishSound.currentTime = 0;
                extinguishSound.play().catch(e => console.log('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫'));
            }
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '0');
            ambientGlow.setAttribute('intensity', '0');
            
            // –í–∏–º–∏–∫–∞—î–º–æ –±—ñ–≥–∞—é—á—ñ –≤–æ–≥–Ω–∏–∫–∏
            if (chasingLightsInterval) {
                clearInterval(chasingLightsInterval);
                chasingLightsInterval = null;
            }
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Å–Ω—ñ–≥–æ–ø–∞–¥
            if (snowContainer) {
                snowContainer.setAttribute('visible', 'false');
            }
            
            // –†–æ–±–∏–º–æ –≤–æ–≥–Ω–∏–∫–∏ –ø—Ä–æ–∑–æ—Ä–∏–º–∏
            lights.forEach(light => {
                if (!light) return;
                light.setAttribute('opacity', '0.3');
                light.setAttribute('color', '#000000');
                light.setAttribute('emissive', '#000000');
                light.setAttribute('emissive-intensity', '0');
                light.setAttribute('scale', '1 1 1');
                
                // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const animations = light.querySelectorAll('a-animation');
                animations.forEach(anim => anim.remove());
            });
            
            // –°–∫–∞—Å–æ–≤—É—î–º–æ —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–≤–∏–º–∫–Ω–µ–Ω–Ω—è
            clearTimeout(garlandTimeout);
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ –≥—ñ—Ä–ª—è–Ω–¥–∏ (–¥–ª—è cleanup)
        function stopGarland() {
            extinguishGarland();
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å–∫–∏–¥–∞–Ω–Ω—è UI
        function resetUI() {
            musicBtn.textContent = 'üéµ –ú—É–∑–∏–∫–∞';
            musicBtn.classList.remove('active', 'off');
            micBtn.textContent = 'üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è';
            micBtn.classList.remove('active', 'off');
            lightsBtn.textContent = '‚ú® –£–≤—ñ–º–∫–Ω—É—Ç–∏';
            lightsBtn.classList.remove('active');
            settingsBtn.textContent = '‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è';
            settingsBtn.classList.remove('active');
            
            voiceStatus.textContent = '–†–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ';
            voiceIndicator.classList.remove('active');
            voiceIndicator.style.background = '#ff4444';
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –º—É–∑–∏–∫–∏
        musicBtn.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play()
                    .then(() => {
                        musicBtn.textContent = 'üîá –ú—É–∑–∏–∫–∞';
                        musicBtn.classList.add('active');
                        isMusicPlaying = true;
                    })
                    .catch(e => {
                        console.log("üîá –ü–æ–º–∏–ª–∫–∞ –º—É–∑–∏–∫–∏:", e);
                        musicBtn.textContent = 'üéµ –ü–æ–º–∏–ª–∫–∞';
                        musicBtn.classList.add('off');
                    });
            } else {
                bgMusic.pause();
                musicBtn.textContent = 'üéµ –ú—É–∑–∏–∫–∞';
                musicBtn.classList.remove('active');
                isMusicPlaying = false;
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        micBtn.addEventListener('click', () => {
            if (!isSpeechRecognitionActive) {
                startSpeechRecognition();
            } else {
                stopSpeechRecognition();
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤–æ–≥–Ω—ñ–≤
        lightsBtn.addEventListener('click', () => {
            if (!isGarlandOn) {
                igniteGarland();
            } else {
                extinguishGarland();
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        settingsBtn.addEventListener('click', () => {
            const isShowing = settingsPanel.style.display === 'block';
            settingsPanel.style.display = isShowing ? 'none' : 'block';
            settingsBtn.classList.toggle('active', !isShowing);
            settingsBtn.textContent = isShowing ? '‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è' : '‚úñÔ∏è –ó–∞–∫—Ä–∏—Ç–∏';
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Å–ª–∞–π–¥–µ—Ä—ñ–≤
        sensitivitySlider.addEventListener('input', (e) => {
            settings.sensitivity = parseInt(e.target.value);
            sensitivityValue.textContent = settings.sensitivity;
        });

        heightSlider.addEventListener('input', (e) => {
            const cmValue = parseInt(e.target.value);
            settings.height = cmValue / 100; // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Å–º –≤ –º–µ—Ç—Ä–∏ (1-50—Å–º ‚Üí 0.01-0.5–º)
            heightValue.textContent = cmValue + ' —Å–º';
        });

        sizeSlider.addEventListener('input', (e) => {
            settings.size = parseInt(e.target.value) / 100; // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ % –≤ 0.1-2.0
            sizeValue.textContent = Math.round(settings.size * 100) + '%';
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ —Ä–∞–¥—ñ–æ-–∫–Ω–æ–ø–æ–∫ —Ç–∏–ø—É –º–∞—Ä–∫–µ—Ä–∞
        markerTypeRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                settings.markerType = e.target.value;
            });
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ —á–µ–∫–±–æ–∫—Å—ñ–≤ –µ—Ñ–µ–∫—Ç—ñ–≤
        chasingEffectCheckbox.addEventListener('change', (e) => {
            settings.chasingEffect = e.target.checked;
            if (isGarlandOn && settings.chasingEffect) {
                startChasingLights();
            } else if (chasingLightsInterval) {
                clearInterval(chasingLightsInterval);
                chasingLightsInterval = null;
            }
        });

        snowEffectCheckbox.addEventListener('change', (e) => {
            settings.snowEffect = e.target.checked;
            if (snowContainer) {
                snowContainer.setAttribute('visible', settings.snowEffect && isGarlandOn);
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
        applySettingsBtn.addEventListener('click', applySettings);

        // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') { // –ü—Ä–æ–±—ñ–ª - —É–≤—ñ–º–∫/–≤–∏–º–∫
                if (!lightsBtn.disabled) {
                    if (!isGarlandOn) {
                        igniteGarland();
                    } else {
                        extinguishGarland();
                    }
                }
            } else if (e.key === 'm' || e.key === 'M') { // M - –º—É–∑–∏–∫–∞
                musicBtn.click();
            } else if (e.key === 's' || e.key === 'S') { // S - –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                settingsBtn.click();
            } else if (e.key === 'v' || e.key === 'V') { // V - –≥–æ–ª–æ—Å
                micBtn.click();
            } else if (e.key === 'c' || e.key === 'C') { // C - –±—ñ–≥–∞—é—á—ñ –≤–æ–≥–Ω–∏–∫–∏
                settings.chasingEffect = !settings.chasingEffect;
                chasingEffectCheckbox.checked = settings.chasingEffect;
                if (isGarlandOn && settings.chasingEffect) {
                    startChasingLights();
                }
            }
        });

        // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ "–∑–∞–ª–∏–ø–∞–Ω–Ω—è" –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤–∫–ª–∞–¥–∫—É - –≤–∏–º–∏–∫–∞—î–º–æ –≤—Å–µ
                if (isSpeechRecognitionActive) {
                    stopSpeechRecognition();
                }
                if (bgMusic && !bgMusic.paused) {
                    bgMusic.pause();
                }
                stopGarland();
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        window.addEventListener('beforeunload', () => {
            stopSpeechRecognition();
            stopGarland();
            if (bgMusic) bgMusic.pause();
        });

        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –º—É–∑–∏–∫–∏
        bgMusic.addEventListener('canplay', () => {
            console.log('üéµ –ú—É–∑–∏–∫–∞ –≥–æ—Ç–æ–≤–∞');
        });

        bgMusic.addEventListener('error', (e) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –º—É–∑–∏–∫–∏:', e);
            musicBtn.textContent = 'üéµ –ù–µ–º–∞—î —Ñ–∞–π–ª—É';
            musicBtn.classList.add('off');
            musicBtn.disabled = true;
        });

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å
        function fixHeight() {
            document.body.style.height = window.innerHeight + 'px';
        }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        console.log('üöÄ AR –ì—ñ—Ä–ª—è–Ω–¥–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!');
        updateSliderValues();
    </script>
</body>
</html>
