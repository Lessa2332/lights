<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR —è–ª–∏–Ω–∫–∞ –∑ –≥—ñ—Ä–ª—è–Ω–¥–æ—é">
    <title>üéÑ AR –Ø–ª–∏–Ω–∫–∞ –∑ –≥—ñ—Ä–ª—è–Ω–¥–æ—é</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: Arial, sans-serif;
        }
        
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 71, 42, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffd700;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .loader h1 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
        }

        .loader p {
            font-size: 1.2em;
            margin: 10px 0;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
            font-size: 3em;
        }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è */
        .controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 90%;
        }

        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 215, 0, 0.9);
            color: #1a472a;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            min-width: 140px;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-2px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .control-btn.active {
            background: #4CAF50;
            color: white;
        }

        .control-btn.off {
            background: #f44336;
            color: white;
        }

        /* –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó */
        .hint {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            text-align: center;
            max-width: 80%;
            backdrop-filter: blur(10px);
            border: 2px solid #ffd700;
            display: none;
        }

        .hint h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
        }

        .hint p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* –°—Ç–∞—Ç—É—Å */
        .status {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 15px;
            text-align: center;
            font-size: 0.9em;
            backdrop-filter: blur(10px);
            display: none;
            border: 1px solid #ffd700;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .controls {
                bottom: 10px;
                gap: 8px;
            }
            
            .control-btn {
                padding: 10px 15px;
                font-size: 0.8em;
                min-width: 120px;
            }
            
            .hint {
                top: 10px;
                padding: 10px 15px;
            }
            
            .status {
                top: 70px;
                padding: 8px 15px;
            }
            
            .loader h1 {
                font-size: 1.5em;
            }
            
            .loader p {
                font-size: 1em;
            }
        }

        @media (max-width: 480px) {
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 6px;
            }
            
            .control-btn {
                width: 90%;
                max-width: 250px;
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class="loader" id="loader">
        <div class="pulse">üéÑ</div>
        <h1>AR –Ø–ª–∏–Ω–∫–∞ –∑ –≥—ñ—Ä–ª—è–Ω–¥–æ—é</h1>
        <p>–ù–∞–≤–µ–¥—ñ—Ç—å –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –∑ —è–ª–∏–Ω–∫–æ—é</p>
        <p>–ú–∞—Ä–∫–µ—Ä –º–∞—î –±—É—Ç–∏ —Ñ–æ—Ä–º–∞—Ç—É –ê5</p>
    </div>
    
    <!-- –ü—ñ–¥–∫–∞–∑–∫–∞ -->
    <div class="hint" id="hint">
        <h3>üé§ –°–∫–∞–∂—ñ—Ç—å:</h3>
        <p>"–Ø–ª–∏–Ω–æ—á–∫–∞ —Å–≤—ñ—Ç–∏—Å—å!" –∞–±–æ "–Ø–ª–∏–Ω–æ—á–∫–∞ –≥–æ—Ä–∏!"</p>
        <p>–ê–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É "–ó–∞–ø–∞–ª–∏—Ç–∏!"</p>
    </div>
    
    <!-- –°—Ç–∞—Ç—É—Å -->
    <div class="status" id="status">
        <p id="status-text">–ì–æ—Ç–æ–≤–∏–π –¥–æ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è...</p>
    </div>

    <!-- A-Frame —Å—Ü–µ–Ω–∞ -->
    <a-scene
        mindar-image="imageTargetSrc: marcher.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="bg-music" src="music.mp3" preload="auto" loop></audio>
        </a-assets>

        <a-camera
            position="0 0 1.5"
            look-controls="enabled: true"
        ></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –Ø–ª–∏–Ω–∫–∞ –∑ 7 –∫—É–ª—å–∫–∞–º–∏ -->
            <a-entity id="tree" position="0 0 -0.5" scale="0.5 0.5 0.5" visible="false">
                <!-- –û—Å–Ω–æ–≤–∞ —è–ª–∏–Ω–∫–∏ (—Ç—Ä–∏–∫—É—Ç–Ω–∏–∫) -->
                <a-triangle
                    id="tree-body"
                    position="0 0 0"
                    height="1.2"
                    width="1"
                    color="#006400"
                    rotation="-90 0 0"
                ></a-triangle>
                
                <!-- –°—Ç–≤–æ–ª -->
                <a-box
                    position="0 -0.6 0"
                    width="0.1"
                    height="0.2"
                    depth="0.1"
                    color="#8B4513"
                ></a-box>
                
                <!-- 7 –∫—É–ª—å–æ–∫-–≤–æ–≥–Ω–∏–∫—ñ–≤ —É —Ñ–æ—Ä–º—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ -->
                <a-sphere id="light1" position="0 0.8 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                <a-sphere id="light2" position="-0.2 0.5 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                <a-sphere id="light3" position="0.2 0.5 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                <a-sphere id="light4" position="-0.3 0.2 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                <a-sphere id="light5" position="0.3 0.2 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                <a-sphere id="light6" position="-0.15 -0.1 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                <a-sphere id="light7" position="0.15 -0.1 0" radius="0.04" color="#333333" emissive="#333333" emissive-intensity="0.1"></a-sphere>
                
                <!-- –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –≥—ñ—Ä–ª—è–Ω–¥–∏ -->
                <a-light id="garland-light" type="point" color="#FFD700" intensity="0" distance="3" position="0 0.3 0" visible="true"></a-light>
            </a-entity>
        </a-entity>
    </a-scene>

    <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
    <div class="controls">
        <button id="music-btn" class="control-btn">üéµ –ú—É–∑–∏–∫–∞</button>
        <button id="mic-btn" class="control-btn">üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω</button>
        <button id="lights-btn" class="control-btn">‚ú® –ó–∞–ø–∞–ª–∏—Ç–∏!</button>
    </div>

    <script>
        // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
        const loader = document.getElementById('loader');
        const hint = document.getElementById('hint');
        const status = document.getElementById('status');
        const statusText = document.getElementById('status-text');
        const targetEntity = document.querySelector('[mindar-image-target]');
        const tree = document.getElementById('tree');
        const musicBtn = document.getElementById('music-btn');
        const micBtn = document.getElementById('mic-btn');
        const lightsBtn = document.getElementById('lights-btn');
        const bgMusic = document.getElementById('bg-music');
        const garlandLight = document.getElementById('garland-light');
        
        // –ú–∞—Å–∏–≤ –∑ 7 –∫—É–ª—å–∫–∞–º–∏
        const lights = [
            document.getElementById('light1'),
            document.getElementById('light2'),
            document.getElementById('light3'),
            document.getElementById('light4'),
            document.getElementById('light5'),
            document.getElementById('light6'),
            document.getElementById('light7')
        ];
        
        // –ó–º—ñ–Ω–Ω—ñ —Å—Ç–∞–Ω—É
        let isMusicPlaying = false;
        let isMicActive = false;
        let isGarlandOn = false;
        let audioContext, analyser, dataArray, micStream;
        let activationPhrases = ['—è–ª–∏–Ω–æ—á–∫–∞ —Å–≤—ñ—Ç–∏—Å—å', '—è–ª–∏–Ω–æ—á–∫–∞ –≥–æ—Ä–∏', '–∑–∞–ø–∞–ª–∏ —è–ª–∏–Ω–∫—É', '—É–≤—ñ–º–∫–Ω–∏ –≤–æ–≥–Ω—ñ'];
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤—Å—ñ—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤
        console.log('–ï–ª–µ–º–µ–Ω—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ:');
        console.log('Tree:', tree);
        console.log('Lights found:', lights.filter(l => l).length);
        console.log('Music:', bgMusic);

        // –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ! –Ø–ª–∏–Ω–∫–∞ –∑'—è–≤–ª—è—î—Ç—å—Å—è.");
                loader.style.display = 'none';
                if (tree) {
                    tree.setAttribute('visible', 'true');
                }
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É
                hint.style.display = 'block';
                status.style.display = 'block';
                statusText.textContent = '–°–∫–∞–∂—ñ—Ç—å: "–Ø–ª–∏–Ω–æ—á–∫–∞ —Å–≤—ñ—Ç–∏—Å—å!"';
            });

            targetEntity.addEventListener('targetLost', () => {
                console.log("‚ÑπÔ∏è –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ.");
                if (tree) {
                    tree.setAttribute('visible', 'false');
                }
                // –í–∏–º–∏–∫–∞—î–º–æ –≤—Å–µ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
                turnOffGarland();
                if (bgMusic && !bgMusic.paused) bgMusic.pause();
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                    micStream = null;
                }
                if (audioContext) audioContext.close();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                loader.style.display = 'flex';
                hint.style.display = 'none';
                status.style.display = 'none';
                musicBtn.textContent = 'üéµ –ú—É–∑–∏–∫–∞';
                musicBtn.classList.remove('active', 'off');
                micBtn.textContent = 'üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
                micBtn.classList.remove('active', 'off');
                lightsBtn.textContent = '‚ú® –ó–∞–ø–∞–ª–∏—Ç–∏!';
                lightsBtn.classList.remove('active');
                
                // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω–∏
                isMusicPlaying = false;
                isMicActive = false;
                isGarlandOn = false;
            });
        } else {
            console.error('–ï–ª–µ–º–µ–Ω—Ç mindar-image-target –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏
        function turnOnGarland() {
            if (isGarlandOn) return;
            
            console.log('‚ú® –ó–∞–ø–∞–ª—é—î–º–æ –≥—ñ—Ä–ª—è–Ω–¥—É!');
            isGarlandOn = true;
            lightsBtn.textContent = 'üí´ –ì–æ—Ä–∏—Ç—å!';
            lightsBtn.classList.add('active');
            
            // –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '2');
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –∫–æ–∂–Ω–æ–≥–æ –≤–æ–≥–Ω–∏–∫–∞
            lights.forEach((light, index) => {
                if (!light) return;
                
                // –ó–∞–ø–∞–ª—é—î–º–æ –≤–æ–≥–æ–Ω—å
                light.setAttribute('color', '#FFFF00');
                light.setAttribute('emissive', '#FFFF00');
                light.setAttribute('emissive-intensity', '2');
                
                // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –º–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è
                const animation = document.createElement('a-animation');
                animation.setAttribute('attribute', 'emissive-intensity');
                animation.setAttribute('from', '0.5');
                animation.setAttribute('to', '3');
                animation.setAttribute('dur', '300');
                animation.setAttribute('direction', 'alternate');
                animation.setAttribute('repeat', 'indefinite');
                animation.setAttribute('begin', index * 100 + 'ms');
                light.appendChild(animation);
                
                // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –∫–æ–ª—å–æ—Ä—É
                const colorAnimation = document.createElement('a-animation');
                colorAnimation.setAttribute('attribute', 'color');
                colorAnimation.setAttribute('from', '#FFFF00');
                colorAnimation.setAttribute('to', '#FF4500');
                colorAnimation.setAttribute('dur', '500');
                colorAnimation.setAttribute('direction', 'alternate');
                colorAnimation.setAttribute('repeat', 'indefinite');
                colorAnimation.setAttribute('begin', index * 150 + 'ms');
                light.appendChild(colorAnimation);
            });
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å
            statusText.textContent = '‚ú® –Ø–ª–∏–Ω–∫–∞ —Å–≤—ñ—Ç–∏—Ç—å—Å—è!';
            status.style.display = 'block';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–º–∫–Ω—É—Ç–∏ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (isGarlandOn) {
                    turnOffGarland();
                    statusText.textContent = '–ì—ñ—Ä–ª—è–Ω–¥–∞ –≤–∏–º–∫–Ω—É–ª–∞—Å—å. –°–∫–∞–∂—ñ—Ç—å —â–µ —Ä–∞–∑!';
                }
            }, 10000);
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏
        function turnOffGarland() {
            if (!isGarlandOn) return;
            
            console.log('üí° –í–∏–º–∫–Ω—É—Ç–∏ –≥—ñ—Ä–ª—è–Ω–¥—É');
            isGarlandOn = false;
            lightsBtn.textContent = '‚ú® –ó–∞–ø–∞–ª–∏—Ç–∏!';
            lightsBtn.classList.remove('active');
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '0');
            
            // –í–∏–º–∏–∫–∞—î–º–æ –≤—Å—ñ –≤–æ–≥–Ω–∏–∫–∏
            lights.forEach(light => {
                if (!light) return;
                light.setAttribute('color', '#333333');
                light.setAttribute('emissive', '#333333');
                light.setAttribute('emissive-intensity', '0.1');
                
                // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const animations = light.querySelectorAll('a-animation');
                animations.forEach(anim => anim.remove());
            });
            
            statusText.textContent = '–ì–æ—Ç–æ–≤–∏–π –¥–æ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è...';
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        async function initMic() {
            try {
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(micStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.3;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                micBtn.textContent = 'üé§ –°–ª—É—Ö–∞—î–º–æ...';
                micBtn.classList.add('active');
                isMicActive = true;
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É
                hint.style.display = 'block';
                statusText.textContent = '–°–∫–∞–∂—ñ—Ç—å: "–Ø–ª–∏–Ω–æ—á–∫–∞ —Å–≤—ñ—Ç–∏—Å—å!"';
                status.style.display = 'block';
                
                // –ü–æ—á–∏–Ω–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –∞—É–¥—ñ–æ
                processAudio();
                
            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:', err);
                micBtn.textContent = 'üé§ –ü–æ–º–∏–ª–∫–∞';
                micBtn.classList.add('off');
                statusText.textContent = '–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞';
                hint.style.display = 'block';
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –∞—É–¥—ñ–æ –¥–ª—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è —Å–ª—ñ–≤
        function processAudio() {
            if (!analyser || !isMicActive) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // –ü—Ä–æ—Å—Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≥—É—á–Ω–æ—Å—Ç—ñ
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const avgVolume = sum / dataArray.length;
            
            // –Ø–∫—â–æ –≥—É—á–Ω—ñ—Å—Ç—å –¥–æ—Å—Ç–∞—Ç–Ω—è (—Ö—Ç–æ—Å—å —â–æ—Å—å —Å–∫–∞–∑–∞–≤)
            if (avgVolume > 30) {
                console.log('–ì—É—á–Ω—ñ—Å—Ç—å:', avgVolume);
                
                // –ü—Ä–æ—Å—Ç–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –ø–æ –≥—É—á–Ω–æ—Å—Ç—ñ
                if (!isGarlandOn) {
                    console.log('–†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ –≥–æ–ª–æ—Å! –ó–∞–ø–∞–ª—é—î–º–æ...');
                    turnOnGarland();
                    
                    // –í—ñ–∑—É–∞–ª—å–Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
                    statusText.textContent = 'üé§ –†–æ–∑–ø—ñ–∑–Ω–∞–Ω–æ –≥–æ–ª–æ—Å!';
                    setTimeout(() => {
                        if (isGarlandOn) {
                            statusText.textContent = '‚ú® –Ø–ª–∏–Ω–∫–∞ —Å–≤—ñ—Ç–∏—Ç—å—Å—è!';
                        }
                    }, 1000);
                }
            }
            
            // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ–±—Ä–æ–±–∫—É
            requestAnimationFrame(processAudio);
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –º—É–∑–∏–∫–∏
        musicBtn.addEventListener('click', () => {
            if (bgMusic.paused) {
                bgMusic.play()
                    .then(() => {
                        musicBtn.textContent = 'üîá –ú—É–∑–∏–∫–∞';
                        musicBtn.classList.add('active');
                        isMusicPlaying = true;
                    })
                    .catch(e => {
                        console.log("üîá –ü–æ–º–∏–ª–∫–∞ –º—É–∑–∏–∫–∏:", e);
                        musicBtn.textContent = 'üéµ –ü–æ–º–∏–ª–∫–∞';
                        musicBtn.classList.add('off');
                    });
            } else {
                bgMusic.pause();
                musicBtn.textContent = 'üéµ –ú—É–∑–∏–∫–∞';
                musicBtn.classList.remove('active');
                isMusicPlaying = false;
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        micBtn.addEventListener('click', () => {
            if (!isMicActive) {
                initMic();
            } else {
                // –í–∏–º–∏–∫–∞—î–º–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω
                if (micStream) {
                    micStream.getTracks().forEach(track => track.stop());
                }
                if (audioContext) audioContext.close();
                analyser = null;
                micStream = null;
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                micBtn.textContent = 'üé§ –ú—ñ–∫—Ä–æ—Ñ–æ–Ω';
                micBtn.classList.remove('active');
                isMicActive = false;
                
                // –•–æ–≤–∞—î–º–æ –ø—ñ–¥–∫–∞–∑–∫—É, —è–∫—â–æ –≥—ñ—Ä–ª—è–Ω–¥–∞ –Ω–µ –≥–æ—Ä–∏—Ç—å
                if (!isGarlandOn) {
                    hint.style.display = 'none';
                    status.style.display = 'none';
                }
            }
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è
        lightsBtn.addEventListener('click', () => {
            if (!isGarlandOn) {
                turnOnGarland();
            } else {
                turnOffGarland();
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        window.addEventListener('beforeunload', () => {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) audioContext.close();
            if (bgMusic) bgMusic.pause();
        });

        // –ü–æ—á–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –º—É–∑–∏–∫–∏
        bgMusic.addEventListener('canplay', () => {
            console.log('–ú—É–∑–∏–∫–∞ –≥–æ—Ç–æ–≤–∞ –¥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è');
        });

        bgMusic.addEventListener('error', (e) => {
            console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º—É–∑–∏–∫–∏:', e);
            musicBtn.textContent = 'üéµ –ù–µ–º–∞—î –º—É–∑–∏–∫–∏';
            musicBtn.classList.add('off');
            musicBtn.disabled = true;
        });

        // –î–æ–¥–∞—î–º–æ –≥–æ–ª–æ—Å–æ–≤–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —á–µ—Ä–µ–∑ –ø–æ–¥—ñ—ó
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') { // –ü—Ä–æ–±—ñ–ª
                if (!isGarlandOn) {
                    turnOnGarland();
                }
            }
        });

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å –≤–∏—Å–æ—Ç–∏
        function fixHeight() {
            document.body.style.height = window.innerHeight + 'px';
        }
        fixHeight();
        window.addEventListener('resize', fixHeight);
    </script>
</body>
</html>
