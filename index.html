<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR –≥—ñ—Ä–ª—è–Ω–¥–∞ –¥–ª—è –¥—ñ—Ç–µ–π –∑ –≥–æ–ª–æ—Å–æ–≤–∏–º –∫–µ—Ä—É–≤–∞–Ω–Ω—è–º">
    <title>üéÑ AR –Ø–ª–∏–Ω–æ—á–∫–∞</title>

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Arial', sans-serif;
            touch-action: none;
        }
        
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }

        /* –õ–æ–∞–¥–µ—Ä */
        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a472a, #2e7d32);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffd700;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .loader h1 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .loader p {
            font-size: 1.1em;
            margin: 8px 0;
            opacity: 0.9;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
            font-size: 4em;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }

        /* –ü—Ä–æ—Å—Ç–∞ –∫–Ω–æ–ø–∫–∞ */
        .simple-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            padding: 18px 40px;
            border: none;
            border-radius: 40px;
            background: linear-gradient(145deg, #ff4444, #cc0000);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.4);
            transition: all 0.3s;
            font-family: 'Comic Sans MS', cursive;
            border: 4px solid white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .simple-btn:hover {
            background: linear-gradient(145deg, #ff6666, #ff0000);
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 0, 0, 0.6);
        }

        .simple-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        .simple-btn.active {
            background: linear-gradient(145deg, #4CAF50, #2e7d32);
            box-shadow: 0 8px 20px rgba(0, 255, 0, 0.4);
            border-color: #a5d6a7;
        }

        /* –°–ø—ñ—á-–±–∞–±–ª */
        .speech-bubble {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            border: 3px solid #ffd700;
            z-index: 10001;
            display: none;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.7);
            font-family: 'Comic Sans MS', cursive;
            min-width: 200px;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .simple-btn {
                padding: 16px 35px;
                font-size: 1.1em;
                bottom: 25px;
            }
            
            .speech-bubble {
                font-size: 1.1em;
                top: 40px;
            }
        }

        @media (max-width: 480px) {
            .simple-btn {
                padding: 14px 30px;
                font-size: 1em;
                bottom: 20px;
                width: 90%;
                max-width: 300px;
            }
            
            .loader h1 {
                font-size: 1.5em;
            }
            
            .pulse {
                font-size: 3em;
            }
        }
    </style>
</head>
<body>
    <!-- –õ–æ–∞–¥–µ—Ä -->
    <div class="loader" id="loader">
        <div class="pulse">üéÑ</div>
        <h1>AR –Ø–ª–∏–Ω–æ—á–∫–∞</h1>
        <p>–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä</p>
        <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">–ß–µ–∫–∞–π, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</p>
    </div>
    
    <!-- –°–ø—ñ—á-–±–∞–±–ª –¥–ª—è —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è –º–æ–≤–∏ -->
    <div class="speech-bubble" id="speech-bubble"></div>

    <!-- A-Frame —Å—Ü–µ–Ω–∞ -->
    <a-scene
        mindar-image="imageTargetSrc: marcher.mind;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="ignite-sound" preload="auto">
                <!-- –í–±—É–¥–æ–≤–∞–Ω–∏–π –∫–æ—Ä–æ—Ç–∫–∏–π –∑–≤—É–∫ —á–µ—Ä–µ–∑ data URI -->
                <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
            </audio>
        </a-assets>

        <a-camera
            id="camera"
            position="0 0 1.5"
            look-controls="enabled: true"
        ></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥—ñ—Ä–ª—è–Ω–¥–∏ - –æ–ø—É—Å–∫–∞—î–º–æ –ù–ò–ñ–ß–ï –º–∞—Ä–∫–µ—Ä–∞ -->
            <!-- –ó–º—ñ–Ω–µ–Ω–æ –ø–æ–∑–∏—Ü—ñ—é Y –∑ 0.05 –Ω–∞ -0.15 - –æ–ø—É—Å–∫–∞—î–º–æ –≥—ñ—Ä–ª—è–Ω–¥—É –Ω–∏–∂—á–µ –º–∞—Ä–∫–µ—Ä–∞ -->
            <a-entity id="garland-container" rotation="0 0 0" position="0 -0.15 0" scale="0.8 0.8 0.8">
                <!-- 7 –∫—É–ª—å–æ–∫ –≥—ñ—Ä–ª—è–Ω–¥–∏ —É —Ñ–æ—Ä–º—ñ —Ç—Ä–∏–∫—É—Ç–Ω–∏–∫–∞ - –ø–µ—Ä–µ—Ä–æ–±–ª–µ–Ω–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ -->
                <!-- –¢–µ–ø–µ—Ä –≤–æ–Ω–∏ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ –Ω–∏–∂—á–µ –ø–æ –æ—Å—ñ Y -->
                <!-- –†—è–¥ 1 (–≤–µ—Ä—Ö–Ω—ñ–π) -->
                <a-sphere id="light1" class="garland-light" position="0 -0.03 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 2 -->
                <a-sphere id="light2" class="garland-light" position="-0.15 -0.18 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light3" class="garland-light" position="0.15 -0.18 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 3 -->
                <a-sphere id="light4" class="garland-light" position="-0.25 -0.33 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light5" class="garland-light" position="0.25 -0.33 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –†—è–¥ 4 (–Ω–∏–∂–Ω—ñ–π) -->
                <a-sphere id="light6" class="garland-light" position="-0.1 -0.48 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <a-sphere id="light7" class="garland-light" position="0.1 -0.48 0" 
                    radius="0.05" 
                    color="#000000" 
                    opacity="0.3"
                    transparent="true"
                    emissive="#000000" 
                    emissive-intensity="0">
                </a-sphere>
                
                <!-- –°–Ω—ñ–≥–æ–ø–∞–¥ (–ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º) -->
                <a-entity id="snow-container" position="0 -0.1 0" visible="false">
                    <a-entity particle-system="preset: snow; 
                                               color: #ffffff,#ccccff; 
                                               particleCount: 300; 
                                               velocityValue: 0 0.3 0; 
                                               velocitySpread: 1 0.2 1; 
                                               opacity: 0.6; 
                                               size: 0.01 0.05; 
                                               accelerationValue: 0 -1 0;
                                               blending: additive"></a-entity>
                </a-entity>
                
                <!-- –°–≤—ñ—Ç–ª–æ –≤—ñ–¥ –≥—ñ—Ä–ª—è–Ω–¥–∏ -->
                <a-light id="garland-light" type="point" color="#FFD700" intensity="0" distance="2" position="0 -0.25 0"></a-light>
            </a-entity>
        </a-entity>
    </a-scene>

    <!-- –ü—Ä–æ—Å—Ç–∞ –∫–Ω–æ–ø–∫–∞ -->
    <button id="lights-btn" class="simple-btn" disabled>üéÑ –£–≤—ñ–º–∫–Ω—É—Ç–∏ —è–ª–∏–Ω–æ—á–∫—É!</button>

    <script>
        // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
        const loader = document.getElementById('loader');
        const speechBubble = document.getElementById('speech-bubble');
        const targetEntity = document.querySelector('[mindar-image-target]');
        const garlandContainer = document.getElementById('garland-container');
        const snowContainer = document.getElementById('snow-container');
        const lightsBtn = document.getElementById('lights-btn');
        const garlandLight = document.getElementById('garland-light');
        const igniteSound = document.getElementById('ignite-sound');
        
        // –ú–∞—Å–∏–≤ –∑ 7 –∫—É–ª—å–∫–∞–º–∏
        const lights = Array.from(document.querySelectorAll('.garland-light'));
        
        // –ó–º—ñ–Ω–Ω—ñ —Å—Ç–∞–Ω—É
        let isGarlandOn = false;
        let garlandTimeout = null;
        let micStream = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let audioInterval = null;
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        let settings = {
            sensitivity: 25,     // —á—É—Ç–ª–∏–≤—ñ—Å—Ç—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
            snowEffect: true     // —Å–Ω—ñ–≥–æ–ø–∞–¥
        };
        
        // –§—É–Ω–∫—Ü—ñ—è –ø–æ–∫–∞–∑—É —Å–ø—ñ—á-–±–∞–±–ª–∞
        function showSpeechBubble(text) {
            speechBubble.textContent = text;
            speechBubble.style.display = 'block';
            
            // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥–∏
            clearTimeout(speechBubble.timeout);
            speechBubble.timeout = setTimeout(() => {
                speechBubble.style.display = 'none';
            }, 2000);
        }

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        async function initMicrophone() {
            try {
                // –ó–∞–ø–∏—Ç—É—î–º–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω
                micStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: true
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(micStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.1;
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                // –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                showSpeechBubble("üé§ –°–ª—É—Ö–∞—é... —Å–∫–∞–∂–∏ '–Ø–ª–∏–Ω–æ—á–∫–∞!'");
                
                // –ó–∞–ø—É—Å–∫–∞—î–º–æ –æ–±—Ä–æ–±–∫—É –∞—É–¥—ñ–æ
                processAudio();
                
            } catch (err) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞:', err);
                showSpeechBubble("üîá –î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞!");
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ –∞—É–¥—ñ–æ –¥–ª—è –≤–∏—è–≤–ª–µ–Ω–Ω—è —Å–ª–æ–≤–∞ "–Ø–ª–∏–Ω–æ—á–∫–∞"
        function processAudio() {
            if (!analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // –û–±—á–∏—Å–ª—é—î–º–æ —Å–µ—Ä–µ–¥–Ω—é –≥—É—á–Ω—ñ—Å—Ç—å
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const avgVolume = sum / dataArray.length;
            
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ –ø–æ—Ä—ñ–≥
            if (avgVolume > settings.sensitivity) {
                console.log('üé§ –í–∏—è–≤–ª–µ–Ω–æ –∑–≤—É–∫! –ì—É—á–Ω—ñ—Å—Ç—å:', avgVolume);
                
                // –Ø–∫—â–æ –∑–≤—É–∫ –¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—É—á–Ω–∏–π
                if (avgVolume > settings.sensitivity + 10) {
                    if (!isGarlandOn) {
                        console.log('üî• –°–ª–æ–≤–æ –≤–∏—è–≤–ª–µ–Ω–æ! –ó–∞–ø–∞–ª—é—î–º–æ –≥—ñ—Ä–ª—è–Ω–¥—É');
                        igniteGarland();
                        
                        // –ü–æ–∫–∞–∑—É—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                        showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
                        
                        // –í—ñ–±—Ä–∞—Ü—ñ—è (—è–∫—â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è)
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                    }
                }
            }
            
            // –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –æ–±—Ä–æ–±–∫—É
            if (audioInterval) clearTimeout(audioInterval);
            audioInterval = setTimeout(() => processAudio(), 50);
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞
        function stopMicrophone() {
            if (micStream) {
                micStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) audioContext.close();
            if (audioInterval) clearTimeout(audioInterval);
            analyser = null;
            micStream = null;
            audioContext = null;
            audioInterval = null;
        }
        
        // –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –º–∞—Ä–∫–µ—Ä–∞
        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                console.log("üéØ –ú–∞—Ä–∫–µ—Ä –∑–Ω–∞–π–¥–µ–Ω–æ!");
                loader.style.display = 'none';
                if (garlandContainer) {
                    garlandContainer.setAttribute('visible', 'true');
                }
                lightsBtn.disabled = false;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–º–∏–∫–∞—î–º–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω
                setTimeout(() => {
                    initMicrophone();
                }, 1000);
                
                // –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä—à–µ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                setTimeout(() => {
                    showSpeechBubble("üéÑ –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —è–ª–∏–Ω–æ—á–∫—É!");
                }, 1500);
            });

            targetEntity.addEventListener('targetLost', () => {
                console.log("‚ÑπÔ∏è –ú–∞—Ä–∫–µ—Ä –≤—Ç—Ä–∞—á–µ–Ω–æ.");
                if (garlandContainer) {
                    garlandContainer.setAttribute('visible', 'false');
                }
                // –í–∏–º–∏–∫–∞—î–º–æ –≤—Å–µ –ø—Ä–∏ –≤—Ç—Ä–∞—Ç—ñ –º–∞—Ä–∫–µ—Ä–∞
                stopGarland();
                stopMicrophone();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ UI
                loader.style.display = 'flex';
                speechBubble.style.display = 'none';
                resetUI();
                lightsBtn.disabled = true;
                
                // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞–Ω–∏
                isGarlandOn = false;
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑–∞–ø–∞–ª—é–≤–∞–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏
        function igniteGarland() {
            if (isGarlandOn) return;
            
            console.log('‚ú® –ó–∞–ø–∞–ª—é—î–º–æ —è–ª–∏–Ω–æ—á–∫—É!');
            isGarlandOn = true;
            lightsBtn.textContent = '‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –≥–æ—Ä–∏—Ç—å!';
            lightsBtn.classList.add('active');
            
            // –°–ø—Ä–æ–±–∞ –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫
            if (igniteSound) {
                igniteSound.currentTime = 0;
                igniteSound.play().catch(e => console.log('–ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≤—É–∫'));
            }
            
            // –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '1.5');
            garlandLight.setAttribute('color', '#FFD700');
            
            // –ë—ñ–ª—å—à —Ä–µ–∞–ª—ñ—Å—Ç–∏—á–Ω—ñ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–æ–≥–Ω–∏–∫—ñ–≤
            const fireColors = ['#FFFF00', '#FFA500', '#FF4500', '#FFD700', '#FF8C00'];
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è –≤–æ–≥–Ω–∏–∫—ñ–≤ –∑ –ø—É–ª—å—Å–∞—Ü—ñ—î—é
            lights.forEach((light, index) => {
                if (!light) return;
                
                // –í–∏–ø–∞–¥–∫–æ–≤–∏–π –∫–æ–ª—ñ—Ä –≤–æ–≥–Ω–∏–∫–∞
                const color = fireColors[Math.floor(Math.random() * fireColors.length)];
                
                // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä —Ç–∞ –ø—Ä–æ–∑–æ—Ä—ñ—Å—Ç—å
                light.setAttribute('opacity', '1');
                light.setAttribute('color', color);
                light.setAttribute('emissive', color);
                light.setAttribute('emissive-intensity', '2');
                light.setAttribute('scale', '1 1 1');
                
                // –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const oldAnims = light.querySelectorAll('a-animation');
                oldAnims.forEach(anim => anim.remove());
                
                // –î–û–î–ê–Ñ–ú–û –ü–£–õ–¨–°–ê–¶–Ü–Æ: –∫—É–ª—å–∫–∞ –∑–±—ñ–ª—å—à—É—î—Ç—å—Å—è-–∑–º–µ–Ω—à—É—î—Ç—å—Å—è
                const pulseAnim = document.createElement('a-animation');
                pulseAnim.setAttribute('attribute', 'scale');
                pulseAnim.setAttribute('from', '1 1 1');
                pulseAnim.setAttribute('to', '1.3 1.3 1.3'); // –ó–±—ñ–ª—å—à—É—î–º–æ –Ω–∞ 30%
                pulseAnim.setAttribute('dur', '800 + Math.random() * 400'); // –í–∏–ø–∞–¥–∫–æ–≤–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å
                pulseAnim.setAttribute('direction', 'alternate');
                pulseAnim.setAttribute('repeat', 'indefinite');
                pulseAnim.setAttribute('begin', index * 100 + 'ms'); // –ü–æ—Å–ª—ñ–¥–æ–≤–Ω–µ –∑–∞–ø—É—Å–∫
                pulseAnim.setAttribute('easing', 'ease-in-out');
                light.appendChild(pulseAnim);
                
                // –î–æ–¥–∞—î–º–æ –∞–Ω—ñ–º–∞—Ü—ñ—é –º–µ—Ä–µ—Ö—Ç—ñ–Ω–Ω—è (—ñ–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ñ—Å—Ç—å)
                const flickerAnim = document.createElement('a-animation');
                flickerAnim.setAttribute('attribute', 'emissive-intensity');
                flickerAnim.setAttribute('from', '1.5');
                flickerAnim.setAttribute('to', '3');
                flickerAnim.setAttribute('dur', '300 + Math.random() * 200');
                flickerAnim.setAttribute('direction', 'alternate');
                flickerAnim.setAttribute('repeat', 'indefinite');
                flickerAnim.setAttribute('begin', Math.random() * 1000 + 'ms');
                flickerAnim.setAttribute('easing', 'ease-in-out');
                light.appendChild(flickerAnim);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –∫–æ–ª—å–æ—Ä—É (–¥–ª—è –µ—Ñ–µ–∫—Ç—É –ø–æ–ª—É–º'—è)
                const colorAnim = document.createElement('a-animation');
                colorAnim.setAttribute('attribute', 'color');
                colorAnim.setAttribute('from', color);
                colorAnim.setAttribute('to', fireColors[(index + 1) % fireColors.length]);
                colorAnim.setAttribute('dur', '2000 + Math.random() * 1000');
                colorAnim.setAttribute('direction', 'alternate');
                colorAnim.setAttribute('repeat', 'indefinite');
                colorAnim.setAttribute('begin', Math.random() * 500 + 'ms');
                colorAnim.setAttribute('easing', 'ease-in-out');
                light.appendChild(colorAnim);
                
                // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç—ñ
                const floatAnim = document.createElement('a-animation');
                floatAnim.setAttribute('attribute', 'position');
                floatAnim.setAttribute('from', light.getAttribute('position'));
                const pos = light.getAttribute('position');
                floatAnim.setAttribute('to', `${pos.x} ${pos.y + 0.02} ${pos.z}`);
                floatAnim.setAttribute('dur', '1500 + Math.random() * 1000');
                floatAnim.setAttribute('direction', 'alternate');
                floatAnim.setAttribute('repeat', 'indefinite');
                floatAnim.setAttribute('begin', Math.random() * 800 + 'ms');
                floatAnim.setAttribute('easing', 'ease-in-out');
                light.appendChild(floatAnim);
            });
            
            // –£–≤—ñ–º–∫–Ω—É—Ç–∏ —Å–Ω—ñ–≥–æ–ø–∞–¥, —è–∫—â–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ
            if (settings.snowEffect && snowContainer) {
                snowContainer.setAttribute('visible', 'true');
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥
            clearTimeout(garlandTimeout);
            garlandTimeout = setTimeout(() => {
                if (isGarlandOn) {
                    extinguishGarland();
                    showSpeechBubble("üîÑ –°–∫–∞–∂–∏ '–Ø–ª–∏–Ω–æ—á–∫–∞' –∑–Ω–æ–≤—É!");
                }
            }, 20000);
        }

        // –§—É–Ω–∫—Ü—ñ—è –≤–∏–º–∫–Ω–µ–Ω–Ω—è –≥—ñ—Ä–ª—è–Ω–¥–∏
        function extinguishGarland() {
            if (!isGarlandOn) return;
            
            console.log('üí° –í–∏–º–∫–Ω—É—Ç–∏ —è–ª–∏–Ω–æ—á–∫—É');
            isGarlandOn = false;
            lightsBtn.textContent = 'üéÑ –£–≤—ñ–º–∫–Ω—É—Ç–∏ —è–ª–∏–Ω–æ—á–∫—É!';
            lightsBtn.classList.remove('active');
            
            // –í—ñ–±—Ä–∞—Ü—ñ—è (—è–∫—â–æ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è)
            if (navigator.vibrate) {
                navigator.vibrate([200]);
            }
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Å–≤—ñ—Ç–ª–æ
            garlandLight.setAttribute('intensity', '0');
            
            // –í–∏–º–∏–∫–∞—î–º–æ —Å–Ω—ñ–≥–æ–ø–∞–¥
            if (snowContainer) {
                snowContainer.setAttribute('visible', 'false');
            }
            
            // –†–æ–±–∏–º–æ –≤–æ–≥–Ω–∏–∫–∏ –ø—Ä–æ–∑–æ—Ä–∏–º–∏
            lights.forEach(light => {
                if (!light) return;
                light.setAttribute('opacity', '0.3');
                light.setAttribute('color', '#000000');
                light.setAttribute('emissive', '#000000');
                light.setAttribute('emissive-intensity', '0');
                light.setAttribute('scale', '1 1 1');
                
                // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó
                const animations = light.querySelectorAll('a-animation');
                animations.forEach(anim => anim.remove());
            });
            
            // –°–∫–∞—Å–æ–≤—É—î–º–æ —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ–≤–∏–º–∫–Ω–µ–Ω–Ω—è
            clearTimeout(garlandTimeout);
        }

        // –§—É–Ω–∫—Ü—ñ—è –∑—É–ø–∏–Ω–∫–∏ –≥—ñ—Ä–ª—è–Ω–¥–∏ (–¥–ª—è cleanup)
        function stopGarland() {
            extinguishGarland();
        }

        // –§—É–Ω–∫—Ü—ñ—è —Å–∫–∏–¥–∞–Ω–Ω—è UI
        function resetUI() {
            lightsBtn.textContent = 'üéÑ –£–≤—ñ–º–∫–Ω—É—Ç–∏ —è–ª–∏–Ω–æ—á–∫—É!';
            lightsBtn.classList.remove('active');
        }

        // –û–±—Ä–æ–±–Ω–∏–∫ –∫–Ω–æ–ø–∫–∏
        lightsBtn.addEventListener('click', () => {
            if (!isGarlandOn) {
                igniteGarland();
                showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
            } else {
                extinguishGarland();
                showSpeechBubble("üí§ –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–≥–∞—Å–ª–∞!");
            }
        });

        // –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
        document.addEventListener('keydown', (e) => {
            if (e.key === ' ') { // –ü—Ä–æ–±—ñ–ª - —É–≤—ñ–º–∫/–≤–∏–º–∫
                if (!lightsBtn.disabled) {
                    if (!isGarlandOn) {
                        igniteGarland();
                        showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
                    } else {
                        extinguishGarland();
                        showSpeechBubble("üí§ –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–≥–∞—Å–ª–∞!");
                    }
                }
            } else if (e.key === '—è' || e.key === '–Ø') { // –ö–ª–∞–≤—ñ—à–∞ –Ø
                if (!isGarlandOn && !lightsBtn.disabled) {
                    igniteGarland();
                    showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
                }
            }
        });

        // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ "–∑–∞–ª–∏–ø–∞–Ω–Ω—è" –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤–∫–ª–∞–¥–∫—É - –≤–∏–º–∏–∫–∞—î–º–æ –≤—Å–µ
                stopMicrophone();
                stopGarland();
            }
        });

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–º–∫–Ω–µ–Ω–Ω—è –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ
        window.addEventListener('beforeunload', () => {
            stopMicrophone();
            stopGarland();
        });

        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å
        function fixHeight() {
            document.body.style.height = window.innerHeight + 'px';
        }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
        console.log('üöÄ AR –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!');
        
        // –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è –ø–µ—Ä—à–æ–≥–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
        setTimeout(() => {
            if (loader.style.display !== 'none') {
                showSpeechBubble("üì± –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ –º–∞—Ä–∫–µ—Ä –∑ —è–ª–∏–Ω–æ—á–∫–æ—é!");
            }
        }, 3000);
    </script>
</body>
</html>
