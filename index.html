<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="AR —è–ª–∏–Ω–æ—á–∫–∞ –Ω–∞ –¥–æ–ª–æ–Ω—ñ –¥–ª—è –¥—ñ—Ç–µ–π">
    <title>üéÑ –Ø–ª–∏–Ω–æ—á–∫–∞</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- MindAR –¥–ª—è AR-—Ä–æ–∑–ø—ñ–∑–Ω–∞–≤–∞–Ω–Ω—è -->
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

    <!-- Particle System –¥–ª—è —Å–Ω—ñ–≥—É - –í–ò–î–ê–õ–ï–ù–û, —Ä–æ–±–∏–º–æ –≤–ª–∞—Å–Ω–∏–π —Å–Ω—ñ–≥ -->

    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
            font-family: 'Arial', sans-serif;
            touch-action: none;
        }
        
        a-scene {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            background: transparent;
        }

        .loader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #ffd700;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(3px);
            -webkit-backdrop-filter: blur(3px);
        }

        .loader h1 {
            font-size: 1.8em;
            margin: 0 0 20px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .loader p {
            font-size: 1.1em;
            margin: 8px 0;
            opacity: 0.9;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        .pulse {
            animation: pulse 2s infinite;
            font-size: 4em;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.5));
        }

        .simple-btn {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            padding: 18px 40px;
            border: none;
            border-radius: 40px;
            background: linear-gradient(145deg, #4CAF50, #2e7d32);
            color: white;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0, 128, 0, 0.4);
            transition: all 0.3s;
            font-family: 'Comic Sans MS', cursive;
            border: 4px solid white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .simple-btn:hover {
            background: linear-gradient(145deg, #66BB6A, #388E3C);
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 128, 0, 0.6);
        }

        .simple-btn:active {
            transform: translateX(-50%) translateY(0);
        }

        .simple-btn.active {
            background: linear-gradient(145deg, #ff4444, #cc0000);
            box-shadow: 0 8px 20px rgba(255, 0, 0, 0.4);
            border-color: #ffcdd2;
        }

        .speech-bubble {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            border: 3px solid #ffd700;
            z-index: 10001;
            display: none;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.7);
            font-family: 'Comic Sans MS', cursive;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .simple-btn { padding: 16px 35px; font-size: 1.1em; bottom: 25px; }
            .speech-bubble { font-size: 1.1em; top: 40px; }
        }

        @media (max-width: 480px) {
            .simple-btn { padding: 14px 30px; font-size: 1em; bottom: 20px; width: 90%; max-width: 300px; }
            .loader h1 { font-size: 1.5em; }
            .pulse { font-size: 3em; }
        }
        
        /* –°–Ω—ñ–∂–∏–Ω–∫–∏ */
        .snowflake {
            position: absolute;
            top: -10px;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            box-shadow: 0 0 5px white;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="pulse">üéÑ</div>
        <h1>–Ø–ª–∏–Ω–æ—á–∫–∞</h1>
        <p>–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —è–ª–∏–Ω–∫—É</p>
        <p style="margin-top: 20px; font-size: 0.9em; opacity: 0.7;">–ß–µ–∫–∞–π, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è...</p>
    </div>
    
    <div class="speech-bubble" id="speech-bubble"></div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–Ω—ñ–∂–∏–Ω–æ–∫ -->
    <div id="snow-container" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1000; display: none;"></div>

    <a-scene
        mindar-image="imageTargetSrc: marcher.mind; filterMinCF:0.0001; filterBeta:0.001"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        embedded
        renderer="colorManagement: true; physicallyCorrectLights: true;"
    >
        <a-assets>
            <audio id="ignite-sound" preload="auto">
                <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
            </audio>
        </a-assets>

        <a-camera
            id="camera"
            position="0 0 1.5"
            look-controls="enabled: true"
        ></a-camera>

        <a-entity mindar-image-target="targetIndex: 0; targetWidth: 0.148">
            <!-- –§–Ü–ö–° –î–õ–Ø ANDROID: targetWidth: 0.148 (—à–∏—Ä–∏–Ω–∞ –ê5 —É –º–µ—Ç—Ä–∞—Ö) -->
            <a-entity id="garland-container" position="0 0 0.02" scale="1 1 1" rotation="0 0 0">
                <!-- –ì—ñ—Ä–ª—è–Ω–¥–∞ ‚Äî 13 –∫—É–ª—å–æ–∫ —É –∑–∏–≥–∑–∞–≥-—Ñ–æ—Ä–º—ñ -->
                <a-sphere class="garland-light" position="0.00  0.30  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="0.06  0.25  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="-0.06 0.20  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="0.08  0.15  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="-0.08 0.10  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="0.10  0.05  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="-0.10 0.00  0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="0.10  -0.05 0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="-0.10 -0.10 0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="0.09  -0.15 0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="-0.09 -0.20 0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="0.07  -0.25 0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>
                <a-sphere class="garland-light" position="-0.07 -0.30 0.002" radius="0.04"
                          material="color: #000000; emissive: #000000; emissiveIntensity: 0; transparent: true; opacity: 0.3"></a-sphere>

                <!-- –ü—Ä–æ—Å—Ç–∏–π —Å–Ω—ñ–≥–æ–ø–∞–¥ -->
                <a-entity id="simple-snow" visible="false">
                    <!-- –ö—ñ–ª—å–∫–∞ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Å—Ñ–µ—Ä –¥–ª—è —Å–Ω—ñ–≥—É -->
                    <a-sphere class="snow-particle" position="-0.15 0.4 0" radius="0.008" material="color: white; opacity: 0.7"></a-sphere>
                    <a-sphere class="snow-particle" position="-0.1 0.5 0.05" radius="0.006" material="color: white; opacity: 0.6"></a-sphere>
                    <a-sphere class="snow-particle" position="0.05 0.45 -0.05" radius="0.007" material="color: white; opacity: 0.8"></a-sphere>
                    <a-sphere class="snow-particle" position="0.12 0.35 0.03" radius="0.005" material="color: white; opacity: 0.5"></a-sphere>
                    <a-sphere class="snow-particle" position="-0.18 0.55 -0.02" radius="0.009" material="color: white; opacity: 0.6"></a-sphere>
                    <a-sphere class="snow-particle" position="0.2 0.4 0.04" radius="0.007" material="color: white; opacity: 0.7"></a-sphere>
                    <a-sphere class="snow-particle" position="0.0 0.6 -0.03" radius="0.006" material="color: white; opacity: 0.5"></a-sphere>
                </a-entity>

                <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ —Å–≤—ñ—Ç–ª–æ -->
                <a-light id="garland-light" type="point" intensity="0" color="#ffaa33" distance="1.5" decay="1" position="0 0.1 0.002"></a-light>
            </a-entity>
        </a-entity>
    </a-scene>

    <button id="lights-btn" class="simple-btn" disabled>üéÑ –°–∫–∞–∂–∏ "–Ø–ª–∏–Ω–æ—á–∫–∞!"</button>

    <script>
        const loader = document.getElementById('loader');
        const speechBubble = document.getElementById('speech-bubble');
        const targetEntity = document.querySelector('[mindar-image-target]');
        const garlandContainer = document.getElementById('garland-container');
        const simpleSnow = document.getElementById('simple-snow');
        const snowContainer = document.getElementById('snow-container');
        const lightsBtn = document.getElementById('lights-btn');
        const garlandLight = document.getElementById('garland-light');
        const igniteSound = document.getElementById('ignite-sound');
        
        const lights = Array.from(document.querySelectorAll('.garland-light'));
        const snowParticles = Array.from(document.querySelectorAll('.snow-particle'));
        
        let isGarlandOn = false;
        let garlandTimeout = null;
        let speechRecognition = null;
        let isSpeechActive = false;
        let isRecognitionStarting = false;
        let flickerIntervals = [];
        let snowAnimations = [];
        let snowInterval = null;

        // –í–ª–∞—Å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Å–Ω—ñ–≥–æ–ø–∞–¥—É
        function createSnowflakes() {
            const container = document.getElementById('snow-container');
            container.innerHTML = '';
            
            const snowflakeCount = 50;
            const snowflakes = [];
            
            for (let i = 0; i < snowflakeCount; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                
                const size = 2 + Math.random() * 5;
                const left = Math.random() * 100;
                const opacity = 0.3 + Math.random() * 0.7;
                const fallDuration = 5 + Math.random() * 10;
                const swayDuration = 3 + Math.random() * 4;
                const swayDistance = 10 + Math.random() * 30;
                
                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                snowflake.style.left = `${left}%`;
                snowflake.style.opacity = `${opacity}`;
                
                container.appendChild(snowflake);
                snowflakes.push(snowflake);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è –ø–∞–¥—ñ–Ω–Ω—è
                snowflake.animate([
                    { transform: `translateY(-20px) translateX(0px)`, opacity: 0 },
                    { transform: `translateY(${window.innerHeight + 20}px) translateX(${swayDistance}px)`, opacity: opacity }
                ], {
                    duration: fallDuration * 1000,
                    easing: 'linear',
                    iterations: Infinity
                });
                
                // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –∞–Ω—ñ–º–∞—Ü—ñ—è —Ö–∏—Ç–∞–≤–∏—Ü—ñ
                snowflake.animate([
                    { transform: `translateX(0px)` },
                    { transform: `translateX(${swayDistance}px)` },
                    { transform: `translateX(0px)` }
                ], {
                    duration: swayDuration * 1000,
                    easing: 'ease-in-out',
                    iterations: Infinity
                });
            }
        }

        function startSnowfall() {
            const container = document.getElementById('snow-container');
            container.style.display = 'block';
            createSnowflakes();
        }

        function stopSnowfall() {
            const container = document.getElementById('snow-container');
            container.style.display = 'none';
            container.innerHTML = '';
        }

        function showSpeechBubble(text) {
            speechBubble.textContent = text;
            speechBubble.style.display = 'block';
            clearTimeout(speechBubble.timeout);
            speechBubble.timeout = setTimeout(() => {
                speechBubble.style.display = 'none';
            }, 2000);
        }

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                showSpeechBubble("üé§ –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –≥–æ–ª–æ—Å!");
                return null;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'uk-UA';
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.maxAlternatives = 3;
            
            recognition.onstart = () => {
                isSpeechActive = true;
                isRecognitionStarting = false;
                showSpeechBubble("üé§ –°–ª—É—Ö–∞—é... —Å–∫–∞–∂–∏ '–Ø–ª–∏–Ω–æ—á–∫–∞!'");
                lightsBtn.textContent = "üé§ –°–ª—É—Ö–∞—é...";
                lightsBtn.classList.add('active');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase();
                if (transcript.includes('—è–ª–∏–Ω–æ—á–∫–∞')) {
                    if (!isGarlandOn) {
                        igniteGarland();
                        showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
                    } else {
                        extinguishGarland();
                        showSpeechBubble("üí§ –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–≥–∞—Å–ª–∞!");
                    }
                } else {
                    showSpeechBubble(`"${transcript}" - —Å–∫–∞–∂–∏ "–Ø–ª–∏–Ω–æ—á–∫–∞!"`);
                }
            };
            
            recognition.onerror = (event) => {
                isRecognitionStarting = false;
                if (event.error === 'not-allowed') {
                    showSpeechBubble("üîá –î–æ–∑–≤–æ–ª—å –¥–æ—Å—Ç—É–ø –¥–æ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞!");
                    lightsBtn.textContent = "üé§ –î–æ–∑–≤–æ–ª—å –º—ñ–∫—Ä–æ—Ñ–æ–Ω";
                    lightsBtn.classList.remove('active');
                    isSpeechActive = false;
                } else {
                    setTimeout(() => {
                        if (isSpeechActive && !isRecognitionStarting) {
                            startSpeechRecognition();
                        }
                    }, 1000);
                }
            };
            
            recognition.onend = () => {
                if (isSpeechActive && !isRecognitionStarting) {
                    setTimeout(() => {
                        try {
                            if (!isRecognitionStarting) {
                                isRecognitionStarting = true;
                                recognition.start();
                            }
                        } catch (e) {
                            isRecognitionStarting = false;
                            setTimeout(() => {
                                if (isSpeechActive) startSpeechRecognition();
                            }, 2000);
                        }
                    }, 500);
                }
            };
            
            return recognition;
        }
        
        function startSpeechRecognition() {
            if (isRecognitionStarting) return;
            if (!speechRecognition) speechRecognition = initSpeechRecognition();
            if (speechRecognition) {
                try {
                    isRecognitionStarting = true;
                    speechRecognition.start();
                } catch (e) {
                    isRecognitionStarting = false;
                    showSpeechBubble("‚ùå –ü–æ–º–∏–ª–∫–∞ –º—ñ–∫—Ä–æ—Ñ–æ–Ω–∞");
                    setTimeout(() => {
                        if (!isRecognitionStarting && isSpeechActive) startSpeechRecognition();
                    }, 2000);
                }
            }
        }
        
        function stopSpeechRecognition() {
            isSpeechActive = false;
            isRecognitionStarting = false;
            if (speechRecognition) {
                try { speechRecognition.stop(); } catch (e) {}
                speechRecognition = null;
            }
            lightsBtn.textContent = 'üéÑ –°–∫–∞–∂–∏ "–Ø–ª–∏–Ω–æ—á–∫–∞!"';
            lightsBtn.classList.remove('active');
        }

        function igniteGarland() {
            if (isGarlandOn) return;
            isGarlandOn = true;
            lightsBtn.textContent = '‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –≥–æ—Ä–∏—Ç—å!';
            lightsBtn.classList.add('active');

            if (igniteSound) {
                igniteSound.currentTime = 0;
                igniteSound.play().catch(() => {});
            }

            garlandLight.setAttribute('intensity', '1.0');

            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff8800', '#ff00ff', '#00ffff'];
            
            extinguishGarlandNoUI();

            lights.forEach((light, index) => {
                if (!light) return;
                setTimeout(() => {
                    if (!isGarlandOn || !light) return;

                    const color = colors[index % colors.length];
                    light.setAttribute('material', {
                        color: color,
                        emissive: color,
                        emissiveIntensity: 2,
                        transparent: true,
                        opacity: 1
                    });

                    const interval = setInterval(() => {
                        if (!isGarlandOn || !light) {
                            clearInterval(interval);
                            return;
                        }
                        const intense = 1.5 + Math.random() * 1.5;
                        light.setAttribute('material', 'emissiveIntensity', intense);
                    }, 200 + Math.random() * 300);

                    flickerIntervals.push(interval);

                }, index * 180);
            });

            // –ó–∞–ø—É—Å–∫–∞—î–º–æ —Å–Ω—ñ–≥–æ–ø–∞–¥
            if (simpleSnow) simpleSnow.setAttribute('visible', 'true');
            startSnowfall();
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è —Å–Ω—ñ–∂–∏–Ω–æ–∫ –≤ A-Frame
            snowParticles.forEach(particle => {
                if (!particle) return;
                particle.setAttribute('material', 'opacity', 0.7);
                
                const animate = () => {
                    if (!isGarlandOn) return;
                    const pos = particle.getAttribute('position');
                    const newY = pos.y - 0.01;
                    if (newY < -0.5) {
                        particle.setAttribute('position', {
                            x: pos.x,
                            y: 0.6,
                            z: pos.z
                        });
                    } else {
                        particle.setAttribute('position', {
                            x: pos.x + Math.sin(Date.now() * 0.001 + pos.x) * 0.001,
                            y: newY,
                            z: pos.z + Math.cos(Date.now() * 0.001 + pos.z) * 0.001
                        });
                    }
                    requestAnimationFrame(animate);
                };
                animate();
            });

            clearTimeout(garlandTimeout);
            garlandTimeout = setTimeout(() => {
                if (isGarlandOn) {
                    extinguishGarland();
                    showSpeechBubble("–°–∫–∞–∂–∏ ¬´–Ø–ª–∏–Ω–æ—á–∫–∞¬ª —â–µ —Ä–∞–∑!");
                }
            }, 25000);
        }

        function extinguishGarlandNoUI() {
            flickerIntervals.forEach(id => clearInterval(id));
            flickerIntervals = [];
            
            lights.forEach(light => {
                if (!light) return;
                light.setAttribute('material', {
                    color: '#000000',
                    emissive: '#000000',
                    emissiveIntensity: 0,
                    opacity: 0.3
                });
            });
        }

        function extinguishGarland() {
            if (!isGarlandOn) return;
            isGarlandOn = false;
            lightsBtn.textContent = 'üéÑ –°–∫–∞–∂–∏ "–Ø–ª–∏–Ω–æ—á–∫–∞!"';
            lightsBtn.classList.remove('active');
            garlandLight.setAttribute('intensity', '0');
            if (simpleSnow) simpleSnow.setAttribute('visible', 'false');
            stopSnowfall();
            extinguishGarlandNoUI();
            clearTimeout(garlandTimeout);
        }

        function stopGarland() {
            extinguishGarland();
        }

        function resetUI() {
            lightsBtn.textContent = 'üéÑ –°–∫–∞–∂–∏ "–Ø–ª–∏–Ω–æ—á–∫–∞!"';
            lightsBtn.classList.remove('active');
        }

        if (targetEntity) {
            targetEntity.addEventListener('targetFound', () => {
                loader.style.display = 'none';
                if (garlandContainer) garlandContainer.setAttribute('visible', 'true');
                lightsBtn.disabled = false;
                
                // –§–Ü–ö–° –î–õ–Ø iOS: –≥–æ–ª–æ—Å –±–ª–æ–∫—É—î—Ç—å—Å—è –¥–æ –ø–µ—Ä—à–æ–≥–æ —Ç–∞–ø—É
                if (/iPhone|iPad|iPod/.test(navigator.userAgent)) {
                    showSpeechBubble("–ù–∞—Ç–∏—Å–Ω–∏ –∫–Ω–æ–ø–∫—É —ñ —Å–∫–∞–∂–∏ ¬´–Ø–ª–∏–Ω–æ—á–∫–∞!¬ª");
                    lightsBtn.textContent = "–ù–∞—Ç–∏—Å–Ω–∏ —ñ –≥–æ–≤–æ—Ä–∏!";
                } else {
                    setTimeout(() => {
                        if (!isSpeechActive) startSpeechRecognition();
                    }, 1000);
                }
                
                setTimeout(() => {
                    showSpeechBubble("üéÑ –¢—Ä–∏–º–∞–π –º–∞—Ä–∫–µ—Ä –Ω–∞ –¥–æ–ª–æ–Ω—ñ!");
                }, 1500);
            });

            targetEntity.addEventListener('targetLost', () => {
                if (garlandContainer) garlandContainer.setAttribute('visible', 'false');
                stopGarland();
                stopSpeechRecognition();
                loader.style.display = 'flex';
                speechBubble.style.display = 'none';
                resetUI();
                lightsBtn.disabled = true;
                isGarlandOn = false;
            });
        }

        lightsBtn.addEventListener('click', () => {
            // –§–Ü–ö–° –î–õ–Ø iOS: –∞–∫—Ç–∏–≤—É—î–º–æ –≥–æ–ª–æ—Å –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ
            if (!isSpeechActive && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
                startSpeechRecognition();
                return;
            }
            
            if (!isGarlandOn) {
                igniteGarland();
                showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
            } else {
                extinguishGarland();
                showSpeechBubble("üí§ –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–≥–∞—Å–ª–∞!");
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === ' ' && !lightsBtn.disabled) {
                if (!isGarlandOn) {
                    igniteGarland();
                    showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
                } else {
                    extinguishGarland();
                    showSpeechBubble("üí§ –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–≥–∞—Å–ª–∞!");
                }
            } else if ((e.key === '—è' || e.key === '–Ø') && !isGarlandOn && !lightsBtn.disabled) {
                igniteGarland();
                showSpeechBubble("‚ú® –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–ø–∞–ª–∏–ª–∞—Å—è!");
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopSpeechRecognition();
                stopGarland();
            } else if (!isSpeechActive && document.visibilityState === 'visible' && !lightsBtn.disabled) {
                setTimeout(startSpeechRecognition, 1000);
            }
        });

        window.addEventListener('beforeunload', () => {
            stopSpeechRecognition();
            stopGarland();
        });

        function fixHeight() {
            document.body.style.height = window.innerHeight + 'px';
        }
        fixHeight();
        window.addEventListener('resize', fixHeight);

        console.log('üöÄ –Ø–ª–∏–Ω–æ—á–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞!');
        setTimeout(() => {
            if (loader.style.display !== 'none') {
                showSpeechBubble("üì± –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —è–ª–∏–Ω–∫—É!");
            }
        }, 3000);
    </script>
</body>
</html>

